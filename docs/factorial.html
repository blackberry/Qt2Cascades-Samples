<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- factorial.qdoc -->
  <title>Cascades : Factorial States Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt with Cascades UI Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>Factorial States Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
</ul>
</div>
<h1 class="title">Factorial States Example</h1>
<span class="subtitle"></span>
<!-- $$$factorial-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="factorial-assets-main-qml.html">factorial/assets/main.qml</a></li>
<li><a href="factorial-src-factorial-cpp.html">factorial/src/factorial.cpp</a></li>
<li><a href="factorial-src-factorial-hpp.html">factorial/src/factorial.hpp</a></li>
<li><a href="factorial-src-transitions-cpp.html">factorial/src/transitions.cpp</a></li>
<li><a href="factorial-src-transitions-hpp.html">factorial/src/transitions.hpp</a></li>
<li><a href="factorial-src-main-cpp.html">factorial/src/main.cpp</a></li>
<li><a href="factorial-factorial-pro.html">factorial/factorial.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The Factorial States example shows how to use <a href="http://qt.nokia.com/doc/4.7/statemachine-api.html">The State Machine Framework</a> to calculate the factorial of an integer.</p>
<p class="centerAlign"><img src="images/factorial-example.png" /></p><p>The statechart for calculating the factorial looks as follows:</p>
<p class="centerAlign"><img src="images/factorial-statechart-example.png" /></p><p>In other words, the state machine calculates the factorial of 6 and prints the result.</p>
<pre class="cpp">    <span class="comment">/**
     * The Factorial class stores the values that are used to calculate the factorial.
     * It makes the current x value (x), the original x value (xorig) and the calculated
     * factorial (fac) available as properties, so that they can be accessed by the
     * states and transitions and also by the UI.
     */</span>
    <span class="keyword">class</span> Factorial : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>
    {
        Q_OBJECT

        <span class="comment">// The value properties</span>
        Q_PROPERTY(<span class="type">int</span> x READ x WRITE setX NOTIFY xChanged)
        Q_PROPERTY(<span class="type">int</span> xorig READ xorig WRITE setXorig NOTIFY xorigChanged)
        Q_PROPERTY(<span class="type">int</span> fac READ fac WRITE setFac NOTIFY facChanged)

    <span class="keyword">public</span>:
        Factorial(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

        <span class="comment">// The accessor methods for the value properties</span>
        <span class="type">int</span> x() <span class="keyword">const</span>;
        <span class="type">void</span> setX(<span class="type">int</span> x);

        <span class="type">int</span> xorig() <span class="keyword">const</span>;
        <span class="type">void</span> setXorig(<span class="type">int</span> xorig);

        <span class="type">int</span> fac() <span class="keyword">const</span>;
        <span class="type">void</span> setFac(<span class="type">int</span> fac);

    Q_SIGNALS:
        <span class="comment">// The change notification signals of the value properties</span>
        <span class="type">void</span> xChanged(<span class="type">int</span> value);
        <span class="type">void</span> xorigChanged(<span class="type">int</span> value);
        <span class="type">void</span> facChanged(<span class="type">int</span> value);

    <span class="keyword">private</span>:
        <span class="comment">// The current x value</span>
        <span class="type">int</span> m_x;

        <span class="comment">// The initial x value</span>
        <span class="type">int</span> m_xorig;

        <span class="comment">// The calculated factorial</span>
        <span class="type">int</span> m_fac;
    };</pre>
<p>The Factorial class is used to hold the data of the computation, <tt>x</tt> and <tt>fac</tt>. It also provides a signal that's emitted whenever the value of <tt>x</tt> changes.</p>
<pre class="cpp">    <span class="comment">/**
     * This custom transition has the 'compute' state as source and
     * target state, so it just loops until eventTest() returns 'false'.
     * Inside the onTransition() method the actual work (calculating the factorial)
     * is done.
     */</span>
    <span class="keyword">class</span> FactorialLoopTransition : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsignaltransition.html">QSignalTransition</a></span>
    {
    <span class="keyword">public</span>:
        <span class="comment">// Creates a new factorial loop transition that works on the values of the given Factorial object</span>
        FactorialLoopTransition(Factorial <span class="operator">*</span>fact);

        <span class="comment">// This method is called by the state machine to check whether this transition can be executed</span>
        <span class="keyword">virtual</span> <span class="type">bool</span> eventTest(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qevent.html">QEvent</a></span> <span class="operator">*</span>e);

        <span class="comment">// This method is called by the state machine if this transition is executed</span>
        <span class="keyword">virtual</span> <span class="type">void</span> onTransition(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qevent.html">QEvent</a></span> <span class="operator">*</span>e);

    <span class="keyword">private</span>:
        <span class="comment">// The Factorial object to work on</span>
        Factorial <span class="operator">*</span>m_fact;
    };</pre>
<p>The FactorialLoopTransition class implements the guard (<tt>x</tt> &gt; 1) and calculations (<tt>fac</tt> = <tt>x</tt> * <tt>fac</tt>; <tt>x</tt> = <tt>x</tt> - 1) of the factorial loop.</p>
<pre class="cpp">    <span class="comment">/**
     * This custom transition has the 'compute' state as source and
     * the 'done' state as target state.
     * It tests inside eventTest() whether the calculation of the factorial is finished
     * and returns 'true' in this case.
     */</span>
    <span class="keyword">class</span> FactorialDoneTransition : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qsignaltransition.html">QSignalTransition</a></span>
    {
    <span class="keyword">public</span>:
        <span class="comment">// Creates a new factorial loop transition that works on the values of the given Factorial object</span>
        FactorialDoneTransition(Factorial <span class="operator">*</span>fact);

        <span class="comment">// This method is called by the state machine to check whether this transition can be executed</span>
        <span class="keyword">virtual</span> <span class="type">bool</span> eventTest(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qevent.html">QEvent</a></span> <span class="operator">*</span>e);

    <span class="keyword">private</span>:
        <span class="comment">// The Factorial object to work on</span>
        Factorial <span class="operator">*</span>m_fact;
    };</pre>
<p>The FactorialDoneTransition class implements the guard (<tt>x</tt> &lt;= 1) that terminates the factorial computation. It also prints the final result to standard output.</p>
<pre class="cpp">    Q_DECL_EXPORT <span class="type">int</span> main(<span class="type">int</span> argc<span class="operator">,</span> <span class="type">char</span> <span class="operator">*</span><span class="operator">*</span>argv)
    {
        Application app(argc<span class="operator">,</span> argv);

        Factorial factorial;

        <span class="comment">// Create the state machine</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstatemachine.html">QStateMachine</a></span> machine;</pre>
<p>The application's main() function first creates the application object, a Factorial object and a state machine.</p>
<pre class="cpp">        <span class="comment">// Create the 'compute' state as child of the state machine</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstate.html">QState</a></span> <span class="operator">*</span>compute <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstate.html">QState</a></span>(<span class="operator">&amp;</span>machine);

        <span class="comment">// Initialize the 'fac', 'x' and 'xorig' properties of the Factorial object whenever the compute state is entered</span>
        compute<span class="operator">-</span><span class="operator">&gt;</span>assignProperty(<span class="operator">&amp;</span>factorial<span class="operator">,</span> <span class="string">&quot;fac&quot;</span><span class="operator">,</span> <span class="number">1</span>);
        compute<span class="operator">-</span><span class="operator">&gt;</span>assignProperty(<span class="operator">&amp;</span>factorial<span class="operator">,</span> <span class="string">&quot;x&quot;</span><span class="operator">,</span> <span class="number">6</span>);
        compute<span class="operator">-</span><span class="operator">&gt;</span>assignProperty(<span class="operator">&amp;</span>factorial<span class="operator">,</span> <span class="string">&quot;xorig&quot;</span><span class="operator">,</span> <span class="number">6</span>);

        <span class="comment">/**
         * Add the custom transition to the compute state.
         * Note: This transition has the compute state as source and target state.
         */</span>
        compute<span class="operator">-</span><span class="operator">&gt;</span>addTransition(<span class="keyword">new</span> FactorialLoopTransition(<span class="operator">&amp;</span>factorial));</pre>
<p>The <tt>compute</tt> state is created, and the initial values of <tt>x</tt> and <tt>fac</tt> are defined. A FactorialLoopTransition object is created and added to the state.</p>
<pre class="cpp">        <span class="comment">// Create a final state</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qfinalstate.html">QFinalState</a></span> <span class="operator">*</span>done <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qfinalstate.html">QFinalState</a></span>(<span class="operator">&amp;</span>machine);

        <span class="comment">// Add a custom transition with the 'compute' state as source state and the 'done' state as target state</span>
        FactorialDoneTransition <span class="operator">*</span>doneTransition <span class="operator">=</span> <span class="keyword">new</span> FactorialDoneTransition(<span class="operator">&amp;</span>factorial);
        doneTransition<span class="operator">-</span><span class="operator">&gt;</span>setTargetState(done);
        compute<span class="operator">-</span><span class="operator">&gt;</span>addTransition(doneTransition);</pre>
<p>A final state, <tt>done</tt>, is created, and a FactorialDoneTransition object is created with <tt>done</tt> as its target state. The transition is then added to the <tt>compute</tt> state.</p>
<pre class="cpp">        <span class="comment">// Set the 'compute' state as initial state of the state machine</span>
        machine<span class="operator">.</span>setInitialState(compute);

        <span class="comment">// Load the UI description from main.qml</span>
        QmlDocument <span class="operator">*</span>qml <span class="operator">=</span> QmlDocument<span class="operator">::</span>create(<span class="string">&quot;asset:///main.qml&quot;</span>);

        <span class="comment">// Make the Factorial and StateMachine object available to the UI as context properties</span>
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_factorial&quot;</span><span class="operator">,</span> <span class="operator">&amp;</span>factorial);
        qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_machine&quot;</span><span class="operator">,</span> <span class="operator">&amp;</span>machine);

        <span class="comment">// Create the application scene</span>
        AbstractPane <span class="operator">*</span>appPage <span class="operator">=</span> qml<span class="operator">-</span><span class="operator">&gt;</span>createRootObject<span class="operator">&lt;</span>AbstractPane<span class="operator">&gt;</span>();
        Application<span class="operator">::</span>instance()<span class="operator">-</span><span class="operator">&gt;</span>setScene(appPage);

        <span class="keyword">return</span> Application<span class="operator">::</span>exec();
    }</pre>
<p>The machine's initial state is set to be the <tt>compute</tt> state. We export both the factorial and the state machine objects to QML, so that we are able to start the state machine from the UI and display the factorial values. Finally, the application's event loop is entered.</p>
</div>
<!-- @@@factorial -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Portions Copyright 2012 Research In Motion Limited.
     <acronym title="Copyright">&copy;</acronym> 2008-2011 Nokia Corporation and/or its
     subsidiaries. Nokia, Qt and their respective logos are trademarks of Nokia Corporation 
     in Finland and/or other countries worldwide.</p>
  <p>
     All other trademarks are property of their respective owners. <a title="Privacy Policy"
     href="http://qt.nokia.com/about/privacy-policy">Privacy Policy</a></p>
  <br />
  <p>
    Licensees holding valid Qt Commercial licenses may use this document in accordance with the    Qt Commercial License Agreement provided with the Software or, alternatively, in accordance    with the terms contained in a written agreement between you and Nokia.</p>
  <p>
    Alternatively, this document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
