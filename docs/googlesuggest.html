<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- googlesuggest.qdoc -->
  <title>Cascades : Google Suggest Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt with Cascades UI Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>Google Suggest Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#googlesuggest-class-declaration">GoogleSuggest Class Declaration</a></li>
<li class="level1"><a href="#googlesuggest-class-implementation">GoogleSuggest Class Implementation</a></li>
</ul>
</div>
<h1 class="title">Google Suggest Example</h1>
<span class="subtitle"></span>
<!-- $$$googlesuggest-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="googlesuggest-assets-main-qml.html">googlesuggest/assets/main.qml</a></li>
<li><a href="googlesuggest-src-googlesuggest-cpp.html">googlesuggest/src/googlesuggest.cpp</a></li>
<li><a href="googlesuggest-src-googlesuggest-hpp.html">googlesuggest/src/googlesuggest.hpp</a></li>
<li><a href="googlesuggest-src-main-cpp.html">googlesuggest/src/main.cpp</a></li>
<li><a href="googlesuggest-googlesuggest-pro.html">googlesuggest/googlesuggest.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The Google Suggest example demonstrates how to use the <a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html">QNetworkAccessManager</a> class to obtain a list of suggestions from the Google search engine as the user types into a TextField.</p>
<p class="centerAlign"><img src="images/googlesuggest-example.png" /></p><p>The application makes use of the <tt>get</tt> function in <a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html">QNetworkAccessManager</a> to post a request and obtain the result of the search query sent to the Google search engine. The results returned are put into a <a href="http://qt.nokia.com/doc/4.7/qml-listview.html">ListView</a>.</p>
<p>This example is built up by a TextField as the search box, and a <a href="http://qt.nokia.com/doc/4.7/qml-listview.html">ListView</a> used to store the suggestions.</p>
<a name="googlesuggest-class-declaration"></a>
<h2>GoogleSuggest Class Declaration</h2>
<p>This class implements slots for various signals and a number of functions to display the search results and to determent when and how to perform the search.</p>
<pre class="cpp">    <span class="keyword">class</span> GoogleSuggest: <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>
    {
        Q_OBJECT

        <span class="comment">// This property is used to set the input text from the UI</span>
        Q_PROPERTY(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> input READ input WRITE setInput NOTIFY inputChanged)

        <span class="comment">// This property makes the model that contains the results available to the UI</span>
        Q_PROPERTY(bb<span class="operator">::</span>cascades<span class="operator">::</span>DataModel<span class="operator">*</span> model READ model CONSTANT)

    <span class="keyword">public</span>:
        GoogleSuggest();

        <span class="comment">// The accessor methods for the properties</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> input() <span class="keyword">const</span>;
        <span class="type">void</span> setInput(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>input);

        bb<span class="operator">::</span>cascades<span class="operator">::</span>DataModel<span class="operator">*</span> model() <span class="keyword">const</span>;

    Q_SIGNALS:
        <span class="comment">// The change notification signal of the property</span>
        <span class="type">void</span> inputChanged();

        <span class="comment">// This signal is emitted to trigger the ListView to clear its selection</span>
        <span class="type">void</span> clearSelection();

    <span class="keyword">private</span> Q_SLOTS:
        <span class="comment">// This method starts the actual query to the Google web service</span>
        <span class="type">void</span> autoSuggest();

        <span class="comment">// This method is called when the query provides new data</span>
        <span class="type">void</span> handleNetworkData(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a></span> <span class="operator">*</span>reply);

        <span class="comment">// This method adds the parsed choices/hits information to the data model</span>
        <span class="type">void</span> showCompletions(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstringlist.html">QStringList</a></span> <span class="operator">&amp;</span>choices<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstringlist.html">QStringList</a></span> <span class="operator">&amp;</span>hits);

    <span class="keyword">private</span>:
        <span class="comment">// The data model that contains the choices/hits information</span>
        <span class="keyword">mutable</span> bb<span class="operator">::</span>cascades<span class="operator">::</span><span class="type">QMapListDataModel</span> m_model;

        <span class="comment">// The network manager that handles the communication with the web service</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html">QNetworkAccessManager</a></span> m_networkManager;

        <span class="comment">// The time object to delay the start of the query</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qtimer.html">QTimer</a></span> m_timer;

        <span class="comment">// The data the user has typed in</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> m_input;
    };</pre>
<p>The class connects to a TextField and uses a <a href="http://qt.nokia.com/doc/4.7/qml-listview.html">ListView</a> to display the results. Both are defined in the QML. A <a href="http://qt.nokia.com/doc/4.7/qtimer.html">QTimer</a> controls the start of the network requests that are executed using a <a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html">QNetworkAccessManager</a>.</p>
<pre class="qml">    import bb.cascades 1.0

    <span class="type">Page</span> {
        <span class="type">Container</span> {
            <span class="name">layout</span>: <span class="name">DockLayout</span> {}

            <span class="type">ImageView</span> {
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
                <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Fill</span>

                <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/background.png&quot;</span>
            }

            <span class="type">Container</span> {
                <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>
                <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Fill</span>

                <span class="name">leftPadding</span>: <span class="number">30</span>
                <span class="name">topPadding</span>: <span class="number">20</span>
                <span class="name">rightPadding</span>: <span class="number">30</span>
                <span class="name">bottomPadding</span>: <span class="number">30</span>

                <span class="type">TextField</span> {
                    <span class="name">id</span>: <span class="name">search</span>
                    <span class="name">text</span>: <span class="string">&quot;&quot;</span>
                    <span class="name">hintText</span>: <span class="name">qsTr</span> (<span class="string">&quot;Search Google!&quot;</span>)

                    <span class="comment">// Inform the GoogleSuggest object about the new input whenever the input text changes</span>
                    <span class="name">onTextChanging</span>: <span class="name">_googleSuggest</span>.<span class="name">input</span> <span class="operator">=</span> <span class="name">text</span>
                }

                <span class="type"><a href="http://qt.nokia.com/doc/4.7/qml-listview.html">ListView</a></span> {
                    <span class="name">id</span>: <span class="name">suggestions</span>

                    <span class="name">topMargin</span>: <span class="number">10</span>

                    <span class="name">dataModel</span>: <span class="name">_googleSuggest</span>.<span class="name">model</span>

                    <span class="name">listItemComponents</span>: [
                        <span class="type">ListItemComponent</span> {
                            <span class="name">type</span>: <span class="string">&quot;&quot;</span>
                            <span class="type">StandardListItem</span> {
                                <span class="name">title</span>: <span class="name">ListItemData</span>.<span class="name">suggestion</span>
                                <span class="name">status</span>: <span class="name">ListItemData</span>.<span class="name">hits</span>
                                <span class="name">imageSpaceReserved</span>: <span class="number">false</span>
                            }
                        }
                    ]

                    <span class="comment">// Connect the 'clearSelection' signal of the GoogleSuggest object against the 'clearSelection' slot of the ListView</span>
                    <span class="name">onCreationCompleted</span>: <span class="name">_googleSuggest</span>.<span class="name">clearSelection</span>.<span class="name">connect</span>(<span class="name">suggestions</span>.<span class="name">clearSelection</span>)
                }
            }
        }
    }</pre>
<a name="googlesuggest-class-implementation"></a>
<h2>GoogleSuggest Class Implementation</h2>
<p>We start by defining a constant c-string containing the URL to be used in the Google queries. This is the basis for the query. The letters typed into the search box will be added to the query to perform the search itself.</p>
<pre class="cpp">    <span class="preprocessor">#include &quot;googlesuggest.hpp&quot;</span>

    <span class="keyword">using</span> <span class="keyword">namespace</span> bb<span class="operator">::</span>cascades;

    <span class="keyword">const</span> <span class="type">char</span> <span class="operator">*</span>GSUGGEST_URL <span class="operator">=</span> <span class="string">&quot;http://google.com/complete/search?output=toolbar&amp;q=%1&quot;</span>;</pre>
<p>A single-shot <a href="http://qt.nokia.com/doc/4.7/qtimer.html">QTimer</a> is used to start the request when the user has stopped typing for 500 ms.</p>
<p>Finally, we connect the networkManagers <tt>finished()</tt> signal with the <tt>handleNetworkData()</tt> slot to handle the incoming data.</p>
<pre class="cpp">    GoogleSuggest<span class="operator">::</span>GoogleSuggest()
    {
        <span class="comment">// We use a timer that goes off after 500ms to trigger</span>
        <span class="comment">// actually retrieving the suggestions</span>
        m_timer<span class="operator">.</span>setSingleShot(<span class="keyword">true</span>);
        m_timer<span class="operator">.</span>setInterval(<span class="number">500</span>);

        connect(<span class="operator">&amp;</span>m_timer<span class="operator">,</span> SIGNAL(timeout())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(autoSuggest()));

        <span class="comment">// Hook this signal so we get our network requests</span>
        connect(<span class="operator">&amp;</span>m_networkManager<span class="operator">,</span> SIGNAL(finished(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a></span><span class="operator">*</span>))<span class="operator">,</span>
                <span class="keyword">this</span><span class="operator">,</span> SLOT(handleNetworkData(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a></span><span class="operator">*</span>)));
    }</pre>
<p>The <tt>showCompletion()</tt> function updates the data model connected to our <a href="http://qt.nokia.com/doc/4.7/qml-listview.html">ListView</a>. It takes two QStringLists, one with the suggested search terms and the other with the corresponding number of hits.</p>
<pre class="cpp">    <span class="type">void</span> GoogleSuggest<span class="operator">::</span>showCompletions(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstringlist.html">QStringList</a></span> <span class="operator">&amp;</span>choices<span class="operator">,</span> <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstringlist.html">QStringList</a></span> <span class="operator">&amp;</span>hits)
    {
        <span class="keyword">emit</span> clearSelection();

        m_model<span class="operator">.</span>clear();

        <span class="keyword">if</span> (choices<span class="operator">.</span>isEmpty() <span class="operator">|</span><span class="operator">|</span> (choices<span class="operator">.</span>count() <span class="operator">!</span><span class="operator">=</span> hits<span class="operator">.</span>count()))
            <span class="keyword">return</span>;

        <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> choices<span class="operator">.</span>count(); <span class="operator">+</span><span class="operator">+</span>i) {
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvariant.html#QVariantMap-typedef">QVariantMap</a></span> item;

            item<span class="operator">[</span><span class="string">&quot;suggestion&quot;</span><span class="operator">]</span> <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span>(choices<span class="operator">[</span>i<span class="operator">]</span>);
            item<span class="operator">[</span><span class="string">&quot;hits&quot;</span><span class="operator">]</span> <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span>(hits<span class="operator">[</span>i<span class="operator">]</span>);
            m_model<span class="operator">.</span>append(item);
        }
    }</pre>
<p>The <tt>autoSuggest()</tt> slot is called when the timer times out, and uses the text in the TextField to build the complete search query. The query is then passed to the <a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html">QNetworkAccessManager</a>'s <tt>get()</tt> function to start the request.</p>
<pre class="cpp">    <span class="type">void</span> GoogleSuggest<span class="operator">::</span>autoSuggest()
    {
        <span class="keyword">if</span> (m_input<span class="operator">.</span>isEmpty()) {
            m_model<span class="operator">.</span>clear();
            <span class="keyword">return</span>;
        }

        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> url <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(GSUGGEST_URL)<span class="operator">.</span>arg(m_input);

        m_networkManager<span class="operator">.</span>get(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkrequest.html">QNetworkRequest</a></span>(url));
    }</pre>
<p>To extract the data from the reply we use the <tt>readAll()</tt> function, which is inherited from <a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a> and returns a <a href="http://qt.nokia.com/doc/4.7/qbytearray.html">QByteArray</a>. Since this data is encoded in XML we can use a <a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html">QXmlStreamReader</a> to traverse the data and extract the search result as QStrings, which we can stream into two QStringLists used to populate the popup.</p>
<p>Finally, we schedule the <a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a> object for deletion using the <tt>deleteLater</tt> function.</p>
<pre class="cpp">    <span class="type">void</span> GoogleSuggest<span class="operator">::</span>handleNetworkData(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a></span> <span class="operator">*</span>networkReply)
    {
        <span class="keyword">if</span> (<span class="operator">!</span>networkReply<span class="operator">-</span><span class="operator">&gt;</span>error()) {
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstringlist.html">QStringList</a></span> choices;
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstringlist.html">QStringList</a></span> hits;

            <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qbytearray.html">QByteArray</a></span> response(networkReply<span class="operator">-</span><span class="operator">&gt;</span>readAll());
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html">QXmlStreamReader</a></span> xml(response);
            <span class="keyword">while</span> (<span class="operator">!</span>xml<span class="operator">.</span>atEnd()) {
                xml<span class="operator">.</span>readNext();
                <span class="keyword">if</span> (xml<span class="operator">.</span>tokenType() <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html">QXmlStreamReader</a></span><span class="operator">::</span>StartElement) {
                    <span class="keyword">if</span> (xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;suggestion&quot;</span>) {
                        choices <span class="operator">&lt;</span><span class="operator">&lt;</span> xml<span class="operator">.</span>attributes()<span class="operator">.</span>value(<span class="string">&quot;data&quot;</span>)<span class="operator">.</span>toString();
                    } <span class="keyword">else</span> <span class="keyword">if</span> (xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;num_queries&quot;</span>) {
                        hits <span class="operator">&lt;</span><span class="operator">&lt;</span> xml<span class="operator">.</span>attributes()<span class="operator">.</span>value(<span class="string">&quot;int&quot;</span>)<span class="operator">.</span>toString();
                    }
                }
            }

            showCompletions(choices<span class="operator">,</span> hits);
        }

        networkReply<span class="operator">-</span><span class="operator">&gt;</span>deleteLater();
    }</pre>
</div>
<!-- @@@googlesuggest -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Portions Copyright 2012 Research In Motion Limited.
     <acronym title="Copyright">&copy;</acronym> 2008-2011 Nokia Corporation and/or its
     subsidiaries. Nokia, Qt and their respective logos are trademarks of Nokia Corporation 
     in Finland and/or other countries worldwide.</p>
  <p>
     All other trademarks are property of their respective owners. <a title="Privacy Policy"
     href="http://qt.nokia.com/about/privacy-policy">Privacy Policy</a></p>
  <br />
  <p>
    Licensees holding valid Qt Commercial licenses may use this document in accordance with the    Qt Commercial License Agreement provided with the Software or, alternatively, in accordance    with the terms contained in a written agreement between you and Nokia.</p>
  <p>
    Alternatively, this document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
