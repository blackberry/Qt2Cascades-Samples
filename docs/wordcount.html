<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- wordcount.qdoc -->
  <title>Cascades : Word Count Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt with Cascades UI Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>Word Count Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#wordcount">WordCount</a></li>
<li class="level2"><a href="#single-threaded">Single-Threaded</a></li>
<li class="level2"><a href="#multi-threaded">Multi-Threaded</a></li>
</ul>
</div>
<h1 class="title">Word Count Example</h1>
<span class="subtitle"></span>
<!-- $$$wordcount-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="wordcount-assets-main-qml.html">wordcount/assets/main.qml</a></li>
<li><a href="wordcount-src-wordcount-cpp.html">wordcount/src/WordCount.cpp</a></li>
<li><a href="wordcount-src-wordcount-hpp.html">wordcount/src/WordCount.hpp</a></li>
<li><a href="wordcount-src-main-cpp.html">wordcount/src/main.cpp</a></li>
<li><a href="wordcount-wordcount-pro.html">wordcount/wordcount.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The <a href="http://qt.nokia.com/doc/4.7/qtconcurrent.html">QtConcurrent</a> Word Count example demonstrates the use of the map-reduce algorithm when applied to the problem of counting words in a collection of files.</p>
<p class="centerAlign"><img src="images/wordcount-example.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the map-reduce algorithm of the <a href="http://qt.nokia.com/doc/4.7/qtconcurrent.html">QtConcurrent</a> module to execute a parallelizable task distributed over multiple threads to improve the throughput.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The UI of this sample application consists of two buttons, one to start a single-threaded calculation and one to start a multi-threaded calculation. Additionally there are two labels, one that shows the number of files that will be used as input for the calculation and one that shows the number of words in these files and the time it took to count them.</p>
<p>The business logic of the application is encapsulated in the class WordCount, which is exported to the UI as '<a href="#wordcount">_wordCount</a>'.</p>
<pre class="qml">                <span class="type">Label</span> {
                    <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                    <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;Count words of %1 files&quot;</span>).<span class="name">arg</span>(<span class="name">_wordCount</span>.<span class="name">fileCount</span>)
                    <span class="name">textStyle</span>.color: <span class="name">Color</span>.<span class="name">White</span>
                    <span class="name">textStyle</span>.base: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BigText</span>
                }</pre>
<p>The first label contains a text with a placeholder that will be substituted with the number of found files as reported by the 'fileCount' property of the WordCount object.</p>
<pre class="qml">                    <span class="type">Button</span> {
                        <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;Single Threaded&quot;</span>)
                        <span class="name">enabled</span>: !<span class="name">_wordCount</span>.<span class="name">active</span>
                        <span class="name">onClicked</span>: <span class="name">_wordCount</span>.<span class="name">countSingleThreaded</span>()
                    }

                    <span class="type">Button</span> {
                        <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;Multi Threaded&quot;</span>)
                        <span class="name">enabled</span>: !<span class="name">_wordCount</span>.<span class="name">active</span>
                        <span class="name">onClicked</span>: <span class="name">_wordCount</span>.<span class="name">countMultiThreaded</span>()
                    }</pre>
<p>Whenever the user clicks the 'Single Threaded' or 'Multi Threaded' buttons, the countSingleThreaded() or countMultiThreaded() slots of the WordCount object are invoked. The buttons are disabled while a calculation is running.</p>
<pre class="qml">                <span class="type">Label</span> {
                    <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
                    <span class="name">topMargin</span>: <span class="number">40</span>

                    <span class="name">text</span>: <span class="name">qsTr</span>(<span class="string">&quot;%1 words in %2 ms&quot;</span>).<span class="name">arg</span>(<span class="name">_wordCount</span>.<span class="name">wordCount</span>).<span class="name">arg</span>(<span class="name">_wordCount</span>.<span class="name">elapsedTime</span>)
                    <span class="name">textStyle</span>.color: <span class="name">Color</span>.<span class="name">White</span>
                    <span class="name">textStyle</span>.base: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BigText</span>
                }</pre>
<p>The second label contains a text with placeholders as well, but this time they are substituted with the number of counted words and the elapsed time.</p>
<a name="wordcount"></a>
<h2>WordCount</h2>
<p>The WordCount is the central class in this sample application that contains all the business logic. It provides the two slots to count the number of words in a single-threaded or multi-threaded way and properties that make the result available to the UI.</p>
<a name="single-threaded"></a>
<h3>Single-Threaded</h3>
<p>When the user clicks the 'Single Threaded' button, the countSingleThreaded() slot of the WordCount object is invoked.</p>
<pre class="cpp">    <span class="type">void</span> WordCount<span class="operator">::</span>countSingleThreaded()
    {
        <span class="comment">// Mark the application as active</span>
        m_active <span class="operator">=</span> <span class="keyword">true</span>;
        <span class="keyword">emit</span> activeChanged();

        <span class="comment">// Start to measure the time</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qtime.html">QTime</a></span> time;
        time<span class="operator">.</span>start();

        <span class="comment">// Count the words single threaded</span>
        <span class="keyword">const</span> WordCountMap total <span class="operator">=</span> singleThreadedWordCount(m_files);

        <span class="comment">// Update the measured time</span>
        m_elapsedTime <span class="operator">=</span> time<span class="operator">.</span>elapsed();
        <span class="keyword">emit</span> elapsedTimeChanged();

        <span class="comment">// Accumulate the per-file word counts to the total word count</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span><span class="type">int</span><span class="operator">&gt;</span> counts <span class="operator">=</span> total<span class="operator">.</span>values();
        m_wordCount <span class="operator">=</span> std<span class="operator">::</span>accumulate(counts<span class="operator">.</span>begin()<span class="operator">,</span> counts<span class="operator">.</span>end()<span class="operator">,</span> <span class="number">0</span>);
        <span class="keyword">emit</span> wordCountChanged();

        <span class="comment">// Mark the application as inactive</span>
        m_active <span class="operator">=</span> <span class="keyword">false</span>;
        <span class="keyword">emit</span> activeChanged();
    }</pre>
<p>Inside this method at first a timer is started to keep track of the duration of the calculation. Then the helper method singleThreadedWordCount() is called with the list of files to process as parameter (the list of files has been assembled inside the constructor of the WordCount class).</p>
<pre class="cpp">    WordCountMap singleThreadedWordCount(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstringlist.html">QStringList</a></span> <span class="operator">&amp;</span>files)
    {
        WordCountMap wordCount;

        foreach (<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>fileName<span class="operator">,</span> files) {
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qfile.html">QFile</a></span> file(fileName);
            file<span class="operator">.</span>open(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span><span class="operator">::</span>ReadOnly);
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qtextstream.html">QTextStream</a></span> textStream(<span class="operator">&amp;</span>file);
            <span class="keyword">while</span> (textStream<span class="operator">.</span>atEnd() <span class="operator">=</span><span class="operator">=</span> <span class="keyword">false</span>) {
                foreach(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>word<span class="operator">,</span> textStream<span class="operator">.</span>readLine()<span class="operator">.</span>split(<span class="string">&quot; &quot;</span>))
                    wordCount<span class="operator">[</span>word<span class="operator">]</span> <span class="operator">+</span><span class="operator">=</span> <span class="number">1</span>;
            }
        }

        <span class="keyword">return</span> wordCount;
    }</pre>
<p>This method iterates over the list of passed file names, opens one after another and counts the number of words by reading the files line by line. The result is stored in a helper structure WordCountMap which maps the file name to the number of words it contains.</p>
<pre class="cpp">    <span class="keyword">typedef</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qmap.html">QMap</a></span><span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">,</span> <span class="type">int</span><span class="operator">&gt;</span> WordCountMap;</pre>
<p>After the singleThreadedWordCount() call, countSingleThreaded() sums up the total number of words and updates the properties of WordCount accordingly.</p>
<a name="multi-threaded"></a>
<h3>Multi-Threaded</h3>
<p>When the user clicks the 'Multi Threaded' button, the countMultiThreaded() slot of the WordCount object is invoked.</p>
<pre class="cpp">    <span class="type">void</span> WordCount<span class="operator">::</span>countMultiThreaded()
    {
        <span class="comment">// Mark the application as active</span>
        m_active <span class="operator">=</span> <span class="keyword">true</span>;
        <span class="keyword">emit</span> activeChanged();

        <span class="comment">// Start to measure the time</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qtime.html">QTime</a></span> time;
        time<span class="operator">.</span>start();

        <span class="comment">// Count the words multi-threaded by using QtConcurrent</span>
        <span class="keyword">const</span> WordCountMap total <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qtconcurrent.html">QtConcurrent</a></span><span class="operator">::</span>mappedReduced(m_files<span class="operator">,</span> countWords<span class="operator">,</span> reduce);

        <span class="comment">// Update the measured time</span>
        m_elapsedTime <span class="operator">=</span> time<span class="operator">.</span>elapsed();
        <span class="keyword">emit</span> elapsedTimeChanged();

        <span class="comment">// Accumulate the per-file word counts to the total word count</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qlist.html">QList</a></span><span class="operator">&lt;</span><span class="type">int</span><span class="operator">&gt;</span> counts <span class="operator">=</span> total<span class="operator">.</span>values();
        m_wordCount <span class="operator">=</span> std<span class="operator">::</span>accumulate(counts<span class="operator">.</span>begin()<span class="operator">,</span> counts<span class="operator">.</span>end()<span class="operator">,</span> <span class="number">0</span>);
        <span class="keyword">emit</span> wordCountChanged();

        <span class="comment">// Mark the application as inactive</span>
        m_active <span class="operator">=</span> <span class="keyword">false</span>;
        <span class="keyword">emit</span> activeChanged();
    }</pre>
<p>Inside this method a timer is started again to keep track of the duration of the calculation, however this time the <a href="http://qt.nokia.com/doc/4.7/qtconcurrentmap.html#mappedReduced">QtConcurrent::mappedReduced()</a> method is utilized to distribute the counting of words over multiple threads. The mappedReduced() method expects three parameters</p>
<ul>
<li>the container that contains the input data</li>
<li>the map function</li>
<li>the reduce function</li>
</ul>
<p>As input data the list of files is passed again. The map function is the helper method countWords()</p>
<pre class="cpp">    WordCountMap countWords(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>fileName)
    {
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qfile.html">QFile</a></span> file(fileName);
        file<span class="operator">.</span>open(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span><span class="operator">::</span>ReadOnly);
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qtextstream.html">QTextStream</a></span> textStream(<span class="operator">&amp;</span>file);
        WordCountMap wordCount;

        <span class="keyword">while</span> (textStream<span class="operator">.</span>atEnd() <span class="operator">=</span><span class="operator">=</span> <span class="keyword">false</span>) {
            foreach (<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>word<span class="operator">,</span> textStream<span class="operator">.</span>readLine()<span class="operator">.</span>split(<span class="string">&quot; &quot;</span>))
                wordCount<span class="operator">[</span>word<span class="operator">]</span> <span class="operator">+</span><span class="operator">=</span> <span class="number">1</span>;
        }

        <span class="keyword">return</span> wordCount;
    }</pre>
<p>This method is similar to singleThreadedWordCount(), just that it counts the words of <b>one</b> file only.</p>
<p>As reduce function we pass the helper method reduce()</p>
<pre class="cpp">    <span class="type">void</span> reduce(WordCountMap <span class="operator">&amp;</span>result<span class="operator">,</span> <span class="keyword">const</span> WordCountMap <span class="operator">&amp;</span>w)
    {
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qmapiterator.html">QMapIterator</a></span><span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">,</span> <span class="type">int</span><span class="operator">&gt;</span> i(w);
        <span class="keyword">while</span> (i<span class="operator">.</span>hasNext()) {
            i<span class="operator">.</span>next();
            result<span class="operator">[</span>i<span class="operator">.</span>key()<span class="operator">]</span> <span class="operator">+</span><span class="operator">=</span> i<span class="operator">.</span>value();
        }
    }</pre>
<p>This method is invoked by <a href="http://qt.nokia.com/doc/4.7/qtconcurrentmap.html#mappedReduced">QtConcurrent::mappedReduced()</a> on the result after all map functions have been executed.</p>
</div>
<!-- @@@wordcount -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Portions Copyright 2012 Research In Motion Limited.
     <acronym title="Copyright">&copy;</acronym> 2008-2011 Nokia Corporation and/or its
     subsidiaries. Nokia, Qt and their respective logos are trademarks of Nokia Corporation 
     in Finland and/or other countries worldwide.</p>
  <p>
     All other trademarks are property of their respective owners. <a title="Privacy Policy"
     href="http://qt.nokia.com/about/privacy-policy">Privacy Policy</a></p>
  <br />
  <p>
    Licensees holding valid Qt Commercial licenses may use this document in accordance with the    Qt Commercial License Agreement provided with the Software or, alternatively, in accordance    with the terms contained in a written agreement between you and Nokia.</p>
  <p>
    Alternatively, this document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
