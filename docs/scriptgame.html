<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- scriptgame.qdoc -->
  <title>Cascades : Script Game Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt with Cascades UI Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>Script Game Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#player">Player</a></li>
<li class="level1"><a href="#board">Board</a></li>
<li class="level1"><a href="#gamecontroller">GameController</a></li>
</ul>
</div>
<h1 class="title">Script Game Example</h1>
<span class="subtitle"></span>
<!-- $$$scriptgame-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="scriptgame-assets-maze-qml.html">scriptgame/assets/Maze.qml</a></li>
<li><a href="scriptgame-assets-main-qml.html">scriptgame/assets/main.qml</a></li>
<li><a href="scriptgame-src-board-cpp.html">scriptgame/src/Board.cpp</a></li>
<li><a href="scriptgame-src-board-hpp.html">scriptgame/src/Board.hpp</a></li>
<li><a href="scriptgame-src-gamecontroller-cpp.html">scriptgame/src/GameController.cpp</a></li>
<li><a href="scriptgame-src-gamecontroller-hpp.html">scriptgame/src/GameController.hpp</a></li>
<li><a href="scriptgame-src-player-cpp.html">scriptgame/src/Player.cpp</a></li>
<li><a href="scriptgame-src-player-hpp.html">scriptgame/src/Player.hpp</a></li>
<li><a href="scriptgame-src-main-cpp.html">scriptgame/src/main.cpp</a></li>
<li><a href="scriptgame-scriptgame-pro.html">scriptgame/scriptgame.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The Script Game example shows how to extend a C++ application with scripting functionality.</p>
<p class="centerAlign"><img src="images/scriptgame-example.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the <a href="http://qt.nokia.com/doc/4.7/qscriptengine.html">QScriptEngine</a> and <a href="http://qt.nokia.com/doc/4.7/qscriptvalue.html">QScriptValue</a> classes to export C++ objects into a scripting environment, where user written JavaScript scripts can interact with them.</p>
<p>In this example we have a maze with a player inside. The player object is exported to the scripting environment under the identifier 'player'. The user can now move the player by executing JavaScript code snippets like 'player.turnLeft()' to turn the player or 'player.go()' to move the player by one step in the current direction.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The UI of this sample application consists of the following components:</p>
<ul>
<li>The maze where the player is located in</li>
<li>A DropDown to select a predefined JavaScript code snippet</li>
<li>A <tt>TextArea</tt> where the user can enter or modify the JavaScript code snippet</li>
<li>A 'Run Script' button to execute the JavaScript code</li>
</ul>
<p>The business logic of the application is encapsulated in the class GameController, which is exported to the UI as '<a href="#gamecontroller">_gameController</a>'.</p>
<p>The main.qml contains the <tt>Maze</tt> object (implemented in Maze.qml)</p>
<pre class="qml">                    <span class="comment">// The maze board</span>
                    <span class="type">Maze</span> {
                        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
                        <span class="name">verticalAlignment</span>: <span class="name">verticalAlignment</span>.<span class="name">Center</span>
                    }</pre>
<p>and the <tt>TextField</tt> and <tt>Button</tt> to enter and run the script.</p>
<pre class="qml">                    <span class="type">TextArea</span> {
                        <span class="name">id</span>: <span class="name">scriptContent</span>

                        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>

                        <span class="name">layoutProperties</span>: <span class="name">StackLayoutProperties</span> {
                            <span class="name">spaceQuota</span>: <span class="number">1</span>
                        }

                        <span class="name">hintText</span>: <span class="string">&quot;&quot;</span>
                    }

                    <span class="type">Button</span> {
                        <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>

                        <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;Run Script&quot;</span>)
                        <span class="name">onClicked</span>: <span class="name">_gameController</span>.<span class="name">run</span>(<span class="name">scriptContent</span>.<span class="name">text</span>)
                    }</pre>
<p>Whenever the user clicks the 'Run Script' button, the <tt>run()</tt> slot of the GameController object is invoked with the content of the <tt>TextField</tt> as parameter.</p>
<pre class="qml">        <span class="comment">// The board where the player object can be moved</span>
        <span class="type">Container</span> {
            <span class="name">objectName</span>: <span class="string">&quot;board&quot;</span>

            <span class="name">layoutProperties</span>: <span class="name">AbsoluteLayoutProperties</span> {
                <span class="name">positionX</span>: <span class="number">50</span>
                <span class="name">positionY</span>: <span class="number">50</span>
            }

            <span class="name">layout</span>: <span class="name">AbsoluteLayout</span> {}

            <span class="name">preferredWidth</span>: <span class="number">450</span>
            <span class="name">preferredHeight</span>: <span class="number">450</span>
        }</pre>
<p>The Maze.qml contains a <tt>Container</tt> with the 'objectName' property set, so that it can be looked up from within C++. The player and the walls will be placed inside this container.</p>
<a name="player"></a>
<h2>Player</h2>
<p>The <tt>Player</tt> class encapsulates the business logic of a player on the maze board. It provides methods to change direction and position of the player.</p>
<pre class="cpp">    <span class="keyword">class</span> Player : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">,</span> <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qscriptable.html">QScriptable</a></span>
    {
        Q_OBJECT

    <span class="keyword">public</span>:
        <span class="comment">/**
         * The constructor takes the Board object, where the player should play on, as parameter
         */</span>
        Player(Board <span class="operator">*</span>board<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);
        <span class="operator">~</span>Player();

    <span class="keyword">public</span> Q_SLOTS:
        <span class="comment">// This method can be called to reset the Player object to it's initial state</span>
        <span class="type">void</span> reset();

        <span class="comment">// This method turns the player to the left by 90 degree</span>
        <span class="type">void</span> turnLeft();

        <span class="comment">// This method turn the player to the right by 90 degree</span>
        <span class="type">void</span> turnRight();

        <span class="comment">// This method moves the player by on step in its current direction</span>
        <span class="type">void</span> go();

    <span class="keyword">private</span>:
        <span class="comment">/**
         * Describes the possible directions the player can move to
         */</span>
        <span class="keyword">enum</span> Direction {
            Up<span class="operator">,</span>
            Right<span class="operator">,</span>
            Down<span class="operator">,</span>
            Left
        };

        <span class="comment">// The Board object the player is playing on</span>
        Board <span class="operator">*</span>m_board;

        <span class="comment">// The tile that represents the player in the UI</span>
        bb<span class="operator">::</span>cascades<span class="operator">::</span>ImageView <span class="operator">*</span>m_playerTile;

        <span class="comment">// The direction the player is currently moving</span>
        Direction m_currentDirection;

        <span class="comment">// The current position of the player on the board</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span> m_currentPosition;
    };</pre>
<p>The <tt>Player</tt> class also stores a reference to the UI object (<tt>ImageView</tt>) that represents the player on the screen.</p>
<p>Inside the constructor we create the <tt>ImageView</tt>, load the player image and add it to the <tt>Container</tt> that acts as board.</p>
<pre class="cpp">    Player<span class="operator">::</span>Player(Board <span class="operator">*</span>board<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_board(board)
        <span class="operator">,</span> m_playerTile(<span class="keyword">new</span> ImageView)
        <span class="operator">,</span> m_currentDirection(Down)
        <span class="operator">,</span> m_currentPosition(<span class="number">0</span><span class="operator">,</span> <span class="number">0</span>)
    {
        <span class="comment">// Initialize the player tile and add it to the board container</span>
        m_playerTile<span class="operator">-</span><span class="operator">&gt;</span>setPreferredWidth(s_tileSize);
        m_playerTile<span class="operator">-</span><span class="operator">&gt;</span>setPreferredHeight(s_tileSize);
        m_playerTile<span class="operator">-</span><span class="operator">&gt;</span>setImage(Image(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qurl.html">QUrl</a></span>(<span class="string">&quot;asset:///images/player.png&quot;</span>)));
        m_board<span class="operator">-</span><span class="operator">&gt;</span>board()<span class="operator">-</span><span class="operator">&gt;</span>add(m_playerTile);

        <span class="comment">/**
         * Ensure that x/y position is really 0, otherwise using the translationX/translationY properties
         * does not work as expected.
         */</span>
        AbsoluteLayoutProperties <span class="operator">*</span>properties <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>AbsoluteLayoutProperties<span class="operator">*</span><span class="operator">&gt;</span>(m_playerTile<span class="operator">-</span><span class="operator">&gt;</span>layoutProperties());
        <span class="keyword">if</span> (properties) {
            properties<span class="operator">-</span><span class="operator">&gt;</span>setPositionX(<span class="number">0</span>);
            properties<span class="operator">-</span><span class="operator">&gt;</span>setPositionY(<span class="number">0</span>);
        }
    }</pre>
<p>If the <tt>turnLeft()</tt> method is invoked, we rotate the <tt>ImageView</tt> to the left by 90 degree and update the direction variable depending on the current direction.</p>
<pre class="cpp">    <span class="type">void</span> Player<span class="operator">::</span>turnLeft()
    {
        <span class="comment">// Just rotate the tile, in a later version we can use different images for each direction</span>
        m_playerTile<span class="operator">-</span><span class="operator">&gt;</span>setRotationZ(m_playerTile<span class="operator">-</span><span class="operator">&gt;</span>rotationZ() <span class="operator">-</span> <span class="number">90</span>);

        <span class="comment">// Update the direction depending on the current direction</span>
        <span class="keyword">switch</span> (m_currentDirection) {
            <span class="keyword">case</span> Up:
                m_currentDirection <span class="operator">=</span> Left;
                <span class="keyword">break</span>;
            <span class="keyword">case</span> Right:
                m_currentDirection <span class="operator">=</span> Up;
                <span class="keyword">break</span>;
            <span class="keyword">case</span> Down:
                m_currentDirection <span class="operator">=</span> Right;
                <span class="keyword">break</span>;
            <span class="keyword">case</span> Left:
                m_currentDirection <span class="operator">=</span> Down;
                <span class="keyword">break</span>;
        }
    }</pre>
<p>If the <tt>turnLeft()</tt> method is invoked, we rotate the <tt>ImageView</tt> to the right by 90 degree and update the direction variable depending on the current direction.</p>
<pre class="cpp">    <span class="type">void</span> Player<span class="operator">::</span>turnRight()
    {
        <span class="comment">// Just rotate the tile, in a later version we can use different images for each direction</span>
        m_playerTile<span class="operator">-</span><span class="operator">&gt;</span>setRotationZ(m_playerTile<span class="operator">-</span><span class="operator">&gt;</span>rotationZ() <span class="operator">+</span> <span class="number">90</span>);

        <span class="comment">// Update the direction depending on the current direction</span>
        <span class="keyword">switch</span> (m_currentDirection) {
            <span class="keyword">case</span> Up:
                m_currentDirection <span class="operator">=</span> Right;
                <span class="keyword">break</span>;
            <span class="keyword">case</span> Right:
                m_currentDirection <span class="operator">=</span> Down;
                <span class="keyword">break</span>;
            <span class="keyword">case</span> Down:
                m_currentDirection <span class="operator">=</span> Left;
                <span class="keyword">break</span>;
            <span class="keyword">case</span> Left:
                m_currentDirection <span class="operator">=</span> Up;
                <span class="keyword">break</span>;
        }
    }</pre>
<p>If the <tt>go()</tt> method is invoked, calculate the new position depending on our current position and the current direction. If the <tt>canMoveTo()</tt> method of the <tt>Board</tt> object returns <tt>true</tt> (that means there is no wall) for the new position, we update our position and also adapt the position of the <tt>ImageView</tt> on screen.</p>
<pre class="cpp">    <span class="type">void</span> Player<span class="operator">::</span>go()
    {
        <span class="comment">// Update the current position of the player depending on the current direction</span>
        <span class="keyword">switch</span> (m_currentDirection) {
            <span class="keyword">case</span> Up:
                <span class="keyword">if</span> (m_board<span class="operator">-</span><span class="operator">&gt;</span>canMoveTo(m_currentPosition<span class="operator">.</span>x()<span class="operator">,</span> m_currentPosition<span class="operator">.</span>y() <span class="operator">-</span> <span class="number">1</span>)) {
                    m_currentPosition<span class="operator">.</span>setY(m_currentPosition<span class="operator">.</span>y() <span class="operator">-</span> <span class="number">1</span>);
                }
                <span class="keyword">break</span>;
            <span class="keyword">case</span> Right:
                <span class="keyword">if</span> (m_board<span class="operator">-</span><span class="operator">&gt;</span>canMoveTo(m_currentPosition<span class="operator">.</span>x() <span class="operator">+</span> <span class="number">1</span><span class="operator">,</span> m_currentPosition<span class="operator">.</span>y())) {
                    m_currentPosition<span class="operator">.</span>setX(m_currentPosition<span class="operator">.</span>x() <span class="operator">+</span> <span class="number">1</span>);
                }
                <span class="keyword">break</span>;
            <span class="keyword">case</span> Down:
                <span class="keyword">if</span> (m_board<span class="operator">-</span><span class="operator">&gt;</span>canMoveTo(m_currentPosition<span class="operator">.</span>x()<span class="operator">,</span> m_currentPosition<span class="operator">.</span>y() <span class="operator">+</span> <span class="number">1</span>)) {
                    m_currentPosition<span class="operator">.</span>setY(m_currentPosition<span class="operator">.</span>y() <span class="operator">+</span> <span class="number">1</span>);
                }
                <span class="keyword">break</span>;
            <span class="keyword">case</span> Left:
                <span class="keyword">if</span> (m_board<span class="operator">-</span><span class="operator">&gt;</span>canMoveTo(m_currentPosition<span class="operator">.</span>x() <span class="operator">-</span> <span class="number">1</span><span class="operator">,</span> m_currentPosition<span class="operator">.</span>y())) {
                    m_currentPosition<span class="operator">.</span>setX(m_currentPosition<span class="operator">.</span>x() <span class="operator">-</span> <span class="number">1</span>);
                }
                <span class="keyword">break</span>;
        }

        <span class="comment">// Update the position of the player tile on screen</span>
        m_playerTile<span class="operator">-</span><span class="operator">&gt;</span>setTranslationX(m_currentPosition<span class="operator">.</span>x() <span class="operator">*</span> s_tileSize);
        m_playerTile<span class="operator">-</span><span class="operator">&gt;</span>setTranslationY(m_currentPosition<span class="operator">.</span>y() <span class="operator">*</span> s_tileSize);
    }</pre>
<a name="board"></a>
<h2>Board</h2>
<p>The <tt>Board</tt> class contains all the business logic for handling the maze board. It generates a distribution of blocks on the maze (either static or randomly as configurable via the staticBlockDistribution property) and it also generates the tiles (ImageViews) that are displayed in the UI.</p>
<pre class="cpp">    <span class="keyword">class</span> Board : <span class="keyword">public</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>
    {
        Q_OBJECT

        <span class="comment">// The property that defines whether the block distribution is done statically or randomly</span>
        Q_PROPERTY(<span class="type">bool</span> staticBlockDistribution READ staticBlockDistribution WRITE setStaticBlockDistribution NOTIFY staticBlockDistributionChanged)

    <span class="keyword">public</span>:
        <span class="comment">// We take the Container that represents the maze board as parameter</span>
        Board(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>boardContainer<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

        <span class="comment">/**
         * This method returns whether a player can move to the given position.
         * The position is given in logical coordinates (0-9).
         */</span>
        <span class="type">bool</span> canMoveTo(<span class="type">int</span> x<span class="operator">,</span> <span class="type">int</span> y) <span class="keyword">const</span>;

        <span class="comment">// The accessor methods for the block distribution property</span>
        <span class="type">bool</span> staticBlockDistribution() <span class="keyword">const</span>;
        <span class="type">void</span> setStaticBlockDistribution(<span class="type">bool</span> value);

        bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>board() <span class="keyword">const</span>;

    <span class="keyword">public</span> Q_SLOTS:
        <span class="comment">/**
         * This method will reset the maze board and regenerate all blocks.
         * If the staticBlockDistribution is 'false', the blocks will be placed randomly.
         */</span>
        <span class="type">void</span> reset();

    Q_SIGNALS:
        <span class="comment">// The change notification signal for the block distribution property</span>
        <span class="type">void</span> staticBlockDistributionChanged();

    <span class="keyword">private</span>:
        <span class="comment">// The Container object that represents the maze board in the UI</span>
        bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>m_board;

        <span class="comment">// The list of block tiles that we created</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvector.html">QVector</a></span><span class="operator">&lt;</span>bb<span class="operator">::</span>cascades<span class="operator">::</span>Control<span class="operator">*</span><span class="operator">&gt;</span> m_blocks;

        <span class="comment">// The map where we store the locations of the blocks inside the maze</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvector.html">QVector</a></span><span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qvector.html">QVector</a></span><span class="operator">&lt;</span><span class="type">bool</span><span class="operator">&gt;</span> <span class="operator">&gt;</span> m_blockMap;

        <span class="comment">// The block distribution property</span>
        <span class="type">bool</span> m_staticBlockDistribution;
    };</pre>
<p>Inside the constructor we fill the board representation (a <a href="http://qt.nokia.com/doc/4.7/qvector.html">QVector</a>&lt;<a href="http://qt.nokia.com/doc/4.7/qvector.html">QVector</a>&lt;bool&gt;&gt;) with <tt>false</tt> to mark the complete board as empty. Later on we'll change the values to <tt>true</tt> at the positions where a wall is located.</p>
<pre class="cpp">    Board<span class="operator">::</span>Board(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>boardContainer<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_board(boardContainer)
        <span class="operator">,</span> m_staticBlockDistribution(<span class="keyword">true</span>)
    {
        <span class="comment">// Initialize the random number generator so that we can use it for dynamic block distribution</span>
        qsrand(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qdatetime.html">QDateTime</a></span><span class="operator">::</span>currentDateTime()<span class="operator">.</span>toMSecsSinceEpoch());

        <span class="comment">// Initialize the block map with 'false' for all cells -&gt; no block available</span>
        <span class="keyword">for</span> (<span class="type">int</span> x <span class="operator">=</span> <span class="number">0</span>; x <span class="operator">&lt;</span> s_boardDimension; <span class="operator">+</span><span class="operator">+</span>x) {
            m_blockMap <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvector.html">QVector</a></span><span class="operator">&lt;</span><span class="type">bool</span><span class="operator">&gt;</span>();
            <span class="keyword">for</span> (<span class="type">int</span> y <span class="operator">=</span> <span class="number">0</span>; y <span class="operator">&lt;</span> s_boardDimension; <span class="operator">+</span><span class="operator">+</span>y) {
                m_blockMap<span class="operator">[</span>x<span class="operator">]</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="keyword">false</span>;
            }
        }
    }</pre>
<p>The <tt>canMoveTo()</tt> method returns whether there is no wall at the requested position and therefor we can move the player there.</p>
<pre class="cpp">    <span class="type">bool</span> Board<span class="operator">::</span>canMoveTo(<span class="type">int</span> x<span class="operator">,</span> <span class="type">int</span> y) <span class="keyword">const</span>
    {
        <span class="comment">// We can't move beyond the borders of the board</span>
        <span class="keyword">if</span> (x <span class="operator">&lt;</span> <span class="number">0</span> <span class="operator">|</span><span class="operator">|</span> x <span class="operator">&gt;</span><span class="operator">=</span> s_boardDimension <span class="operator">|</span><span class="operator">|</span> y <span class="operator">&lt;</span> <span class="number">0</span> <span class="operator">|</span><span class="operator">|</span> y <span class="operator">&gt;</span><span class="operator">=</span> s_boardDimension)
            <span class="keyword">return</span> <span class="keyword">false</span>;

        <span class="comment">// We can't move to a coordinate where a block is located</span>
        <span class="keyword">return</span> (m_blockMap<span class="operator">[</span>x<span class="operator">]</span><span class="operator">[</span>y<span class="operator">]</span> <span class="operator">=</span><span class="operator">=</span> <span class="keyword">false</span>);
    }</pre>
<p>The <tt>reset()</tt> method rebuilds the layout of the maze. Depending on the 'staticBlockDistribution' property it places a couple of walls at fixed or random positions.</p>
<pre class="cpp">    <span class="type">void</span> Board<span class="operator">::</span><a href="http://qt.nokia.com/doc/4.7/qtextstream.html#reset">reset</a>()
    {
        <span class="comment">// Remove all block controls from the board...</span>
        foreach(Control <span class="operator">*</span>block<span class="operator">,</span> m_blocks) {
            m_board<span class="operator">-</span><span class="operator">&gt;</span>remove(block);
        }

        <span class="comment">// ... and delete them</span>
        <a href="http://qt.nokia.com/doc/4.7/qtalgorithms.html#qDeleteAll">qDeleteAll</a>(m_blocks);
        m_blocks<span class="operator">.</span>clear();

        <span class="comment">// Clear our internal block map</span>
        <span class="keyword">for</span> (<span class="type">int</span> x <span class="operator">=</span> <span class="number">0</span>; x <span class="operator">&lt;</span> s_boardDimension; <span class="operator">+</span><span class="operator">+</span>x) {
            <span class="keyword">for</span> (<span class="type">int</span> y <span class="operator">=</span> <span class="number">0</span>; y <span class="operator">&lt;</span> s_boardDimension; <span class="operator">+</span><span class="operator">+</span>y) {
                m_blockMap<span class="operator">[</span>x<span class="operator">]</span><span class="operator">[</span>y<span class="operator">]</span> <span class="operator">=</span> <span class="keyword">false</span>;
            }
        }

        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qvector.html">QVector</a></span><span class="operator">&lt;</span><span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span><span class="operator">&gt;</span> blockCoordinates;

        <span class="keyword">if</span> (m_staticBlockDistribution) {
            <span class="comment">// For static block distribution we use hard-coded coordinates</span>
            blockCoordinates <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">2</span><span class="operator">,</span> <span class="number">8</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">5</span><span class="operator">,</span> <span class="number">5</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">5</span><span class="operator">,</span> <span class="number">0</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">7</span><span class="operator">,</span> <span class="number">0</span>)
                            <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">7</span><span class="operator">,</span> <span class="number">7</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">2</span><span class="operator">,</span> <span class="number">7</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">1</span><span class="operator">,</span> <span class="number">4</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">0</span><span class="operator">,</span> <span class="number">5</span>)
                            <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">1</span><span class="operator">,</span> <span class="number">8</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">4</span><span class="operator">,</span> <span class="number">0</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">6</span><span class="operator">,</span> <span class="number">3</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">6</span><span class="operator">,</span> <span class="number">4</span>)
                            <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">2</span><span class="operator">,</span> <span class="number">0</span>) <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">4</span><span class="operator">,</span> <span class="number">5</span>);
        } <span class="keyword">else</span> {
            <span class="comment">// For dynamic block distribution we use random coordinates</span>
            <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> <span class="number">20</span>; <span class="operator">+</span><span class="operator">+</span>i) {
                <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span> newPoint(qrand() <span class="operator">%</span> s_boardDimension<span class="operator">,</span> qrand() <span class="operator">%</span> s_boardDimension);

                <span class="keyword">if</span> (blockCoordinates<span class="operator">.</span>contains(newPoint)) <span class="comment">// contains a block already</span>
                    <span class="keyword">continue</span>;

                <span class="keyword">if</span> (newPoint <span class="operator">=</span><span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span>(<span class="number">0</span><span class="operator">,</span> <span class="number">0</span>)) <span class="comment">// that's the starting place for the player</span>
                    <span class="keyword">continue</span>;

                blockCoordinates <span class="operator">&lt;</span><span class="operator">&lt;</span> newPoint;
            }
        }

        <span class="comment">// Generate the new blocks</span>
        foreach (<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpoint.html">QPoint</a></span> position<span class="operator">,</span> blockCoordinates) {
            <span class="comment">// Mark as occupied in blockMap</span>
            m_blockMap<span class="operator">[</span>position<span class="operator">.</span>x()<span class="operator">]</span><span class="operator">[</span>position<span class="operator">.</span>y()<span class="operator">]</span> <span class="operator">=</span> <span class="keyword">true</span>;

            <span class="comment">// Create block tile</span>
            ImageView <span class="operator">*</span>block <span class="operator">=</span> <span class="keyword">new</span> ImageView();
            block<span class="operator">-</span><span class="operator">&gt;</span>setPreferredWidth(<span class="number">50</span>);
            block<span class="operator">-</span><span class="operator">&gt;</span>setPreferredHeight(<span class="number">50</span>);
            block<span class="operator">-</span><span class="operator">&gt;</span>setImage(Image(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qurl.html">QUrl</a></span>(<span class="string">&quot;asset:///images/block.png&quot;</span>)));
            block<span class="operator">-</span><span class="operator">&gt;</span>setTranslationX(position<span class="operator">.</span>x() <span class="operator">*</span> s_tileSize);
            block<span class="operator">-</span><span class="operator">&gt;</span>setTranslationY(position<span class="operator">.</span>y() <span class="operator">*</span> s_tileSize);

            <span class="comment">// Add the block tile to the board container...</span>
            m_board<span class="operator">-</span><span class="operator">&gt;</span>add(block);

            <span class="comment">// ... and store the object in our internal list, so that we can clean it up later on</span>
            m_blocks <span class="operator">&lt;</span><span class="operator">&lt;</span> block;
        }
    }</pre>
<a name="gamecontroller"></a>
<h2>GameController</h2>
<p>The <tt>GameController</tt> is the central class of this application. It contains the objects that encapsulate the business logic (<tt>Board</tt> and <tt>Player</tt>) and also the <a href="http://qt.nokia.com/doc/4.7/qscriptengine.html">QScriptEngine</a>, which is responsible for changing the properties of the <tt>Board</tt> and <tt>Player</tt> objects according to the JavaScript input.</p>
<pre class="cpp">    <span class="type">void</span> GameController<span class="operator">::</span><a href="http://qt.nokia.com/doc/4.7/qtextstream.html#reset">reset</a>()
    {
        <span class="comment">// Reset the script engine</span>

        <span class="comment">/**
         * We have to delete the script engine with deleteLater() here, because this method is called
         * by the script engine itself, so we should not call 'delete m_scriptEngine' while it is used.
         */</span>
        m_scriptEngine<span class="operator">-</span><span class="operator">&gt;</span>deleteLater();
        m_scriptEngine <span class="operator">=</span> <span class="keyword">new</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qscriptengine.html">QScriptEngine</a></span>(<span class="keyword">this</span>);

        <span class="comment">/**
         * Create a wrapper object for the GameController itself since we want to
         * access its reset() method from within the scripts.
         */</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qscriptvalue.html">QScriptValue</a></span> scriptController <span class="operator">=</span> m_scriptEngine<span class="operator">-</span><span class="operator">&gt;</span>newQObject(<span class="keyword">this</span>);

        <span class="comment">// Export it to the script engine environment</span>
        m_scriptEngine<span class="operator">-</span><span class="operator">&gt;</span>globalObject()<span class="operator">.</span>setProperty(<span class="string">&quot;controller&quot;</span><span class="operator">,</span> scriptController);

        <span class="comment">// Create a wrapper object for the Board object...</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qscriptvalue.html">QScriptValue</a></span> scriptBoard <span class="operator">=</span> m_scriptEngine<span class="operator">-</span><span class="operator">&gt;</span>newQObject(m_board);

        <span class="comment">// ... and export it to the script engine environment</span>
        m_scriptEngine<span class="operator">-</span><span class="operator">&gt;</span>globalObject()<span class="operator">.</span>setProperty(<span class="string">&quot;board&quot;</span><span class="operator">,</span> scriptBoard);

        <span class="comment">// Create a wrapper object for the Player object...</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qscriptvalue.html">QScriptValue</a></span> scriptPlayer <span class="operator">=</span> m_scriptEngine<span class="operator">-</span><span class="operator">&gt;</span>newQObject(m_player);

        <span class="comment">// ... and export it to the script engine environment as well</span>
        m_scriptEngine<span class="operator">-</span><span class="operator">&gt;</span>globalObject()<span class="operator">.</span>setProperty(<span class="string">&quot;player&quot;</span><span class="operator">,</span> scriptPlayer);

        <span class="comment">// Make the constructor function for new Player objects known to the script engine environment</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qscriptvalue.html">QScriptValue</a></span> createPlayerFunc <span class="operator">=</span> m_scriptEngine<span class="operator">-</span><span class="operator">&gt;</span>newFunction(constructNewPlayer);
        m_scriptEngine<span class="operator">-</span><span class="operator">&gt;</span>globalObject()<span class="operator">.</span>setProperty(<span class="string">&quot;Player&quot;</span><span class="operator">,</span> createPlayerFunc);
    }</pre>
<p>The <tt>reset()</tt> method is the one that sets up the scripting environment. For that it recreates a <a href="http://qt.nokia.com/doc/4.7/qscriptengine.html">QScriptEngine</a> object, which will do all the JavaScript parsing and execution. Exporting the <tt>GameController</tt>, <tt>Board</tt> and <tt>Player</tt> object to the scripting environment can simply be done by calling <a href="http://qt.nokia.com/doc/4.7/qscriptengine.html#newQObject">newQObject()</a> on the <a href="http://qt.nokia.com/doc/4.7/qscriptengine.html">QScriptEngine</a> to get a <a href="http://qt.nokia.com/doc/4.7/qscriptvalue.html">QScriptValue</a> that wrapps the C++ object, and then calling <a href="http://qt.nokia.com/doc/4.7/qscriptvalue.html#setProperty">setProperty()</a> on the global object to assign a name to it.</p>
<p>To allow the user to create new <tt>Player</tt> objects from within the JavaScript, we have to register a constructor function that is called whenever the JavaScript contains a statement like 'var p = new Player(board)'. This is done by wrapping the <tt>constructNewPlayer()</tt> function inside a <a href="http://qt.nokia.com/doc/4.7/qscriptvalue.html">QScriptValue</a> and register it to the scripting environment under the name 'Player'.</p>
<pre class="cpp">    <span class="comment">/**
     * This function is called by the script engine if the user creates new Player objects from
     * within the script. (e.g. 'var p = new Player(board)')
     */</span>
    <span class="keyword">static</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qscriptvalue.html">QScriptValue</a></span> constructNewPlayer(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qscriptcontext.html">QScriptContext</a></span> <span class="operator">*</span>context<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qscriptengine.html">QScriptEngine</a></span> <span class="operator">*</span>engine)
    {
        <span class="comment">/**
         * Since the Player class expects a Board object as parameter to the constructor we
         * have to pass it in the script and extract it here again.
         */</span>
        Board <span class="operator">*</span>board <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>Board<span class="operator">*</span><span class="operator">&gt;</span>(context<span class="operator">-</span><span class="operator">&gt;</span>argument(<span class="number">0</span>)<span class="operator">.</span>toQObject());
        <span class="keyword">if</span> (<span class="operator">!</span>board) {
            <span class="comment">// If no valid Board object was passed, we throw an error...</span>
            <span class="keyword">return</span> context<span class="operator">-</span><span class="operator">&gt;</span>throwError(<span class="string">&quot;Missing Board parameter in ctor&quot;</span>);
        }

        <span class="comment">// ... otherwise we return a new Player object whose lifetime is managed by the script engine</span>
        <span class="keyword">return</span> engine<span class="operator">-</span><span class="operator">&gt;</span>newQObject(<span class="keyword">new</span> Player(board)<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qscriptengine.html">QScriptEngine</a></span><span class="operator">::</span>ScriptOwnership);
    }</pre>
<p>The <tt>run()</tt> method of the GameController object is invoked whenever the user clicks on the 'Run Script' button.</p>
<pre class="cpp">    <span class="type">void</span> GameController<span class="operator">::</span>run(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>script)
    {
        <span class="comment">// Run the script that is passed in from the UI</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qscriptvalue.html">QScriptValue</a></span> result <span class="operator">=</span> m_scriptEngine<span class="operator">-</span><span class="operator">&gt;</span>evaluate(script);

        <span class="comment">// Update the scriptError property</span>
        <span class="keyword">if</span> (result<span class="operator">.</span>isError()) {
            m_scriptError <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(<span class="string">&quot;%1: %2&quot;</span>)<span class="operator">.</span>arg(result<span class="operator">.</span>property(<span class="string">&quot;lineNumber&quot;</span>)<span class="operator">.</span>toInt32())
                                                         <span class="operator">.</span>arg(result<span class="operator">.</span>toString());
        } <span class="keyword">else</span> {
            m_scriptError<span class="operator">.</span>clear();
        }

        <span class="keyword">emit</span> scriptErrorChanged();

        <span class="comment">/**
         * We call collectGarbage() explicitly here to ensure that Player objects are deleted immediately
         * and their tiles will disappear from the UI.
         */</span>
        m_scriptEngine<span class="operator">-</span><span class="operator">&gt;</span>collectGarbage();
    }</pre>
<p>Inside this method we call the <a href="http://qt.nokia.com/doc/4.7/qscriptengine.html#evaluate">evaluate()</a> method of the <a href="http://qt.nokia.com/doc/4.7/qscriptengine.html">QScriptEngine</a> object to execute the JavaScript code that we got passed in as parameter. The return value can be tested for the occurrence of an error.</p>
</div>
<!-- @@@scriptgame -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Portions Copyright 2012 Research In Motion Limited.
     <acronym title="Copyright">&copy;</acronym> 2008-2011 Nokia Corporation and/or its
     subsidiaries. Nokia, Qt and their respective logos are trademarks of Nokia Corporation 
     in Finland and/or other countries worldwide.</p>
  <p>
     All other trademarks are property of their respective owners. <a title="Privacy Policy"
     href="http://qt.nokia.com/about/privacy-policy">Privacy Policy</a></p>
  <br />
  <p>
    Licensees holding valid Qt Commercial licenses may use this document in accordance with the    Qt Commercial License Agreement provided with the Software or, alternatively, in accordance    with the terms contained in a written agreement between you and Nokia.</p>
  <p>
    Alternatively, this document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
