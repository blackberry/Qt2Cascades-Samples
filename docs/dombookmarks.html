<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- dombookmarks.qdoc -->
  <title>Cascades : DOM Bookmarks Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt with Cascades UI Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>DOM Bookmarks Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#app">App</a></li>
<li class="level1"><a href="#xbelgenerator-class-definition">XbelGenerator Class Definition</a></li>
<li class="level1"><a href="#xbelgenerator-class-implementation">XbelGenerator Class Implementation</a></li>
<li class="level1"><a href="#xbelparser-class-definition">XbelParser Class Definition</a></li>
<li class="level1"><a href="#xbelparser-class-implementation">XbelParser Class Implementation</a></li>
</ul>
</div>
<h1 class="title">DOM Bookmarks Example</h1>
<span class="subtitle"></span>
<!-- $$$dombookmarks-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="dombookmarks-assets-bookmarkitem-qml.html">dombookmarks/assets/BookmarkItem.qml</a></li>
<li><a href="dombookmarks-assets-folderitem-qml.html">dombookmarks/assets/FolderItem.qml</a></li>
<li><a href="dombookmarks-assets-separatoritem-qml.html">dombookmarks/assets/SeparatorItem.qml</a></li>
<li><a href="dombookmarks-assets-main-qml.html">dombookmarks/assets/main.qml</a></li>
<li><a href="dombookmarks-src-app-cpp.html">dombookmarks/src/app.cpp</a></li>
<li><a href="dombookmarks-src-app-hpp.html">dombookmarks/src/app.hpp</a></li>
<li><a href="dombookmarks-src-xbelgenerator-cpp.html">dombookmarks/src/xbelgenerator.cpp</a></li>
<li><a href="dombookmarks-src-xbelgenerator-hpp.html">dombookmarks/src/xbelgenerator.hpp</a></li>
<li><a href="dombookmarks-src-xbelparser-cpp.html">dombookmarks/src/xbelparser.cpp</a></li>
<li><a href="dombookmarks-src-xbelparser-hpp.html">dombookmarks/src/xbelparser.hpp</a></li>
<li><a href="dombookmarks-src-main-cpp.html">dombookmarks/src/main.cpp</a></li>
<li><a href="dombookmarks-dombookmarks-pro.html">dombookmarks/dombookmarks.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The DOM Bookmarks example provides a parser and generator for XML Bookmark Exchange Language (XBEL) files that uses Qt's DOM-based XML API to read and parse the files. The SAX Bookmarks example provides an alternative way to read this type of file.</p>
<p class="centerAlign"><img src="images/dombookmarks-example.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the <a href="http://qt.nokia.com/doc/4.7/qdomdocument.html">QDomDocument</a> and <a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a> classes to parse, modify and generate an XML document. Additionally we'll see how to generate UI objects (that are described in a QML file) on-the-fly and how to access and modify their properties.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The UI of this sample application consists of three buttons and a container. The first two buttons allow the user to load two different XBEL documents and the third button allows the user to save the currently loaded XBEL document back to file system (including possible changes done to the bookmarks).</p>
<p>The container is the target location for the tree of controls, that visualize the structure of the XBEL document. The XBEL standard defines the elements</p>
<ul>
<li>folder</li>
<li>bookmark</li>
<li>separator</li>
</ul>
<p>The folder is represented by a <tt>Container</tt> with a folder icon and a title label (FolderItem.qml). It provides a custom property 'tagName' and a property 'title' that is aliased to the 'text' property of the <tt>titleField</tt> label. So whenever the 'title' property is changed, the 'text' property will be updated.</p>
<pre class="qml">    <span class="comment">// Container for the visual representation of a XBEL folder element</span>
    <span class="type">Container</span> {
        property <span class="type">string</span> <span class="name">tagName</span>: <span class="string">&quot;folder&quot;</span>
        property <span class="type">alias</span> <span class="name">title</span>: <span class="name">titleField</span>.<span class="name">text</span>

        <span class="name">topMargin</span>: <span class="number">20</span>
        <span class="name">leftPadding</span>: <span class="number">20</span>

        <span class="type">Container</span> {
            <span class="name">layout</span>: <span class="name">StackLayout</span> {
                <span class="name">orientation</span>: <span class="name">LayoutOrientation</span>.<span class="name">LeftToRight</span>
            }

            <span class="comment">// A standard ImageView</span>
            <span class="type">ImageView</span> {
                <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/folder.png&quot;</span>
                <span class="name">preferredWidth</span>: <span class="number">32</span>
                <span class="name">preferredHeight</span>: <span class="number">32</span>
            }

            <span class="comment">// A standard Label for the folder title element</span>
            <span class="type">Label</span> {
                <span class="name">id</span>: <span class="name">titleField</span>
                <span class="name">leftMargin</span>: <span class="number">10</span>

                <span class="comment">// Defines custom text style</span>
                <span class="type">textStyle</span> {
                    <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">SmallText</span>
                    <span class="name">fontWeight</span>: <span class="name">FontWeight</span>.<span class="name">Bold</span>
                    <span class="name">color</span>: <span class="name">Color</span>.<span class="name">White</span>
                }
            }
        }
    }</pre>
<p>The bookmarks are visualized by a <tt>Container</tt> with a star icon, a title label and a <tt>TextField</tt> that contains the bookmark URL (BookmarkItem.qml). The <tt>TextField</tt> is invisible by default and will be faded in when the user clicks on the title label.</p>
<pre class="qml">    <span class="comment">// Container for the visual representation of a XBEL bookmark element</span>
    <span class="type">Container</span> {
        property <span class="type">string</span> <span class="name">tagName</span>: <span class="string">&quot;bookmark&quot;</span>
        property <span class="type">alias</span> <span class="name">title</span>: <span class="name">titleField</span>.<span class="name">text</span>
        property <span class="type">alias</span> <span class="name">url</span>: <span class="name">urlField</span>.<span class="name">text</span>

        <span class="name">topMargin</span>: <span class="number">10</span>
        <span class="name">leftMargin</span>: <span class="number">20</span>
        <span class="name">leftPadding</span>: <span class="number">20</span>

        <span class="type">Container</span> {
            <span class="name">layout</span>: <span class="name">StackLayout</span> {
                <span class="name">orientation</span>: <span class="name">LayoutOrientation</span>.<span class="name">LeftToRight</span>
            }

            <span class="comment">// A standard ImageView</span>
            <span class="type">ImageView</span> {
                <span class="name">minWidth</span>: <span class="number">82</span>
                <span class="name">minHeight</span>: <span class="number">62</span>
                <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>

                <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/bookmark.png&quot;</span>
                <span class="name">scalingMethod</span>: <span class="name">ScalingMethod</span>.<span class="name">AspectFit</span>
            }

            <span class="comment">// A standard Label for the bookmark title element</span>
            <span class="type">Label</span> {
                <span class="name">id</span>: <span class="name">titleField</span>
                <span class="name">leftMargin</span>: <span class="number">10</span>
                <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>

                <span class="type">textStyle</span> {
                    <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">SmallText</span>
                    <span class="name">color</span>: <span class="name">Color</span>.<span class="name">White</span>
                }

                <span class="name">onTouch</span>: {
                    <span class="keyword">if</span> (<span class="name">event</span>.<span class="name">isDown</span>()) {
                        <span class="name">urlField</span>.<span class="name">visible</span> <span class="operator">=</span> !<span class="name">urlField</span>.<span class="name">visible</span>
                    }
                }
            }
        }

        <span class="comment">// A standard TextField for the bookmark url attribute value</span>
        <span class="type">TextField</span> {
            <span class="name">id</span>: <span class="name">urlField</span>
            <span class="name">leftMargin</span>: <span class="number">10</span>
            <span class="name">visible</span>: <span class="number">false</span>
            <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>

            <span class="type">textStyle</span> {
                <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">SmallText</span>
            }
        }
    }</pre>
<p>A separator is an image of a horizontal line (SeparatorItem.qml).</p>
<pre class="qml">    <span class="comment">// Container used to create a separator black visual line</span>
    <span class="type">Container</span> {
        property <span class="type">string</span> <span class="name">tagName</span>: <span class="string">&quot;separator&quot;</span>

        <span class="name">topMargin</span>: <span class="number">20</span>
        <span class="name">leftPadding</span>: <span class="number">40</span>
        <span class="name">rightPadding</span>: <span class="number">20</span>

        <span class="type">ImageView</span> {
            <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>

            <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/separator.png&quot;</span>
        }
    }</pre>
<p>The business logic of the application is encapsulated in the class App, which is exported to the UI as '<a href="#app">_app</a>'.</p>
<pre class="qml">                    <span class="comment">// A standard Button</span>
                    <span class="type">Button</span> {
                        <span class="name">id</span>: <span class="name">frank</span>
                        <span class="name">layoutProperties</span>: <span class="name">StackLayoutProperties</span> {
                            <span class="name">spaceQuota</span>: <span class="number">1</span>
                        }

                        <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;Frank&quot;</span>)

                        <span class="comment">// Load the selected xbel file on click</span>
                        <span class="name">onClicked</span>: {
                            <span class="name">jennifer</span>.<span class="name">opacity</span> <span class="operator">=</span> <span class="number">0.5</span>;
                            <span class="name">save</span>.<span class="name">opacity</span> <span class="operator">=</span> <span class="number">0.5</span>;
                            <span class="name">frank</span>.<span class="name">opacity</span> <span class="operator">=</span> <span class="number">1.0</span>;
                            <span class="name">_app</span>.<span class="name">load</span> (<span class="string">&quot;frank.xbel&quot;</span>);
                        }
                    }</pre>
<p>Whenever the user clicks one of the load buttons, the <tt>load()</tt> method of the App object is invoked.</p>
<pre class="qml">                    <span class="comment">// A standard Button</span>
                    <span class="type">Button</span> {
                        <span class="name">id</span>: <span class="name">save</span>
                        <span class="name">layoutProperties</span>: <span class="name">StackLayoutProperties</span> {
                            <span class="name">spaceQuota</span>: <span class="number">1</span>
                        }

                        <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;Save&quot;</span>)

                        <span class="comment">// Save the changes to a temporary xbel file in the</span>
                        <span class="comment">// application tmp/ directory</span>
                        <span class="name">onClicked</span>: {
                            <span class="name">frank</span>.<span class="name">opacity</span> <span class="operator">=</span> <span class="number">0.5</span>;
                            <span class="name">jennifer</span>.<span class="name">opacity</span> <span class="operator">=</span> <span class="number">0.5</span>;
                            <span class="name">save</span>.<span class="name">opacity</span> <span class="operator">=</span> <span class="number">1.0</span>;
                            <span class="name">_app</span>.<span class="name">save</span> ();
                        }
                    }</pre>
<p>If the user clicks the 'Save' button, the <tt>save()</tt> method of the App object is invoked.</p>
<pre class="qml">                <span class="comment">// Container for displaying the loaded XBEL output</span>
                <span class="type">ScrollView</span> {
                    <span class="name">topMargin</span>: <span class="number">10</span>
                    <span class="type">scrollViewProperties</span> {
                        <span class="name">scrollMode</span>: <span class="name">ScrollMode</span>.<span class="name">Vertical</span>
                    }
                    <span class="name">layoutProperties</span>: <span class="name">StackLayoutProperties</span> {
                        <span class="name">spaceQuota</span>: <span class="number">1</span>
                    }
                    <span class="type">Container</span> {
                        <span class="name">objectName</span>: <span class="string">&quot;treeContainer&quot;</span>

                        <span class="name">leftPadding</span>: <span class="number">10</span>
                        <span class="name">rightPadding</span>: <span class="number">10</span>
                        <span class="name">bottomPadding</span>: <span class="number">10</span>
                    }
                }</pre>
<p>The container has the 'objectName' property set, so that it can be looked up from within C++.</p>
<a name="app"></a>
<h2>App</h2>
<p>Inside the constructor of <tt>App</tt> we load the main.qml file and retrieve the C++ object that represents the root node of the QML document. With the <a href="http://qt.nokia.com/doc/4.7/qobject.html#findChild">findChild()</a> method we look up the <tt>Container</tt> object where we have assigned 'treeContainer' to the 'objectName' property.</p>
<pre class="cpp">    App<span class="operator">::</span>App()
    {
        <span class="comment">// Load the main QML file and make the App object available as context property</span>
        QmlDocument <span class="operator">*</span>qml <span class="operator">=</span> QmlDocument<span class="operator">::</span>create(<span class="string">&quot;asset:///main.qml&quot;</span>);
        <span class="keyword">if</span> (<span class="operator">!</span>qml<span class="operator">-</span><span class="operator">&gt;</span>hasErrors()) {
            qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_app&quot;</span><span class="operator">,</span> <span class="keyword">this</span>);
            Page <span class="operator">*</span>appPage <span class="operator">=</span> qml<span class="operator">-</span><span class="operator">&gt;</span>createRootObject<span class="operator">&lt;</span>Page<span class="operator">&gt;</span>();
            <span class="keyword">if</span> (appPage) {
                Application<span class="operator">::</span>instance()<span class="operator">-</span><span class="operator">&gt;</span>setScene(appPage);

                <span class="comment">// Retrieve the tree container control from the QML file</span>
                m_treeContainer <span class="operator">=</span> appPage<span class="operator">-</span><span class="operator">&gt;</span>findChild<span class="operator">&lt;</span>Container<span class="operator">*</span><span class="operator">&gt;</span>(<span class="string">&quot;treeContainer&quot;</span>);
            }
        }
    }</pre>
<p>Whenever the user clicks one of the load buttons, the <tt>load()</tt> method of the App object is invoked with the file name passed as parameter.</p>
<pre class="cpp">    <span class="type">void</span> App<span class="operator">::</span>load(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> <span class="operator">&amp;</span>fileName)
    {
        <span class="comment">// Do sanity check</span>
        <span class="keyword">if</span> (<span class="operator">!</span>m_treeContainer)
            <span class="keyword">return</span>;

        <span class="comment">// Update the status property</span>
        m_status <span class="operator">=</span> tr(<span class="string">&quot;Loading...&quot;</span>);
        <span class="keyword">emit</span> statusChanged();

        <span class="comment">// Clean all previous generated bookmark controls from the tree container</span>
        m_treeContainer<span class="operator">-</span><span class="operator">&gt;</span>removeAll();

        <span class="comment">// Create the XBEL parser and pass the tree container it will work on</span>
        XbelParser parser(m_treeContainer);

        <span class="comment">// Open the XBEL file which the user has selected</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qfile.html">QFile</a></span> file(<span class="string">&quot;app/native/assets/&quot;</span> <span class="operator">+</span> fileName);
        <span class="keyword">if</span> (<span class="operator">!</span>file<span class="operator">.</span>open(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span><span class="operator">::</span>ReadOnly))
            <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#qWarning">qWarning</a>(<span class="string">&quot;unable to open file&quot;</span>);

        <span class="comment">// Parse XBEL file and generate the bookmark controls</span>
        <span class="keyword">const</span> <span class="type">bool</span> ok <span class="operator">=</span> parser<span class="operator">.</span>parse(<span class="operator">&amp;</span>file);

        <span class="comment">// Update the status property again</span>
        <span class="keyword">if</span> (ok)
            m_status <span class="operator">=</span> tr(<span class="string">&quot;Loaded successfully&quot;</span>);
        <span class="keyword">else</span>
            m_status <span class="operator">=</span> parser<span class="operator">.</span>errorString();

        <span class="keyword">emit</span> statusChanged();
    }</pre>
<p>Inside <tt>load()</tt> we first remove all previously created controls from the <tt>treeContainer</tt> and then use the <tt>XbelParser</tt> class to parse the XML document and generate new controls inside the <tt>treeContainer</tt>.</p>
<p>If the user clicks the 'Save' button, the <tt>save()</tt> method of the App object is invoked.</p>
<pre class="cpp">    <span class="type">void</span> App<span class="operator">::</span>save()
    {
        <span class="comment">// Do sanity check</span>
        <span class="keyword">if</span> (<span class="operator">!</span>m_treeContainer)
            <span class="keyword">return</span>;

        <span class="comment">// Update the status property</span>
        m_status <span class="operator">=</span> tr(<span class="string">&quot;Saving...&quot;</span>);
        <span class="keyword">emit</span> statusChanged();

        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> fileName(<span class="string">&quot;tmp/dombookmarks.xbel&quot;</span>);

        <span class="comment">// Open the target file where the modified XBEL document will be written to</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qfile.html">QFile</a></span> file(fileName);
        file<span class="operator">.</span>open(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span><span class="operator">::</span>WriteOnly);

        <span class="comment">// Create the XBEL generator on the tree container and let it generate the XBEL document from the bookmark controls</span>
        XbelGenerator generator(m_treeContainer);
        <span class="keyword">const</span> <span class="type">bool</span> ok <span class="operator">=</span> generator<span class="operator">.</span>write(<span class="operator">&amp;</span>file);

        <span class="comment">// Update the status property again</span>
        <span class="keyword">if</span> (ok)
            m_status <span class="operator">=</span> tr(<span class="string">&quot;Saved successfully&quot;</span>);
        <span class="keyword">else</span>
            m_status <span class="operator">=</span> tr(<span class="string">&quot;Error while saving&quot;</span>);

        <span class="keyword">emit</span> statusChanged();
    }</pre>
<p>Inside <tt>save()</tt> we try to open the file 'dombookmarks.xbel' inside the applications temp directory and then we use the <tt>XbelGenerator</tt> class to iterate over the <tt>treeContainer</tt>, generate the XML document and store it to the file.</p>
<a name="xbelgenerator-class-definition"></a>
<h2>XbelGenerator Class Definition</h2>
<p>The <tt>XbelGenerator</tt> class contains a reference to the Container instance where the bookmark hierarchy is stored. The actual generation of the XML document is done inside the write() method.</p>
<pre class="cpp">    <span class="comment">/**
     * The XbelGenerator is responsible for generating a XBEL document from the
     * controls in the tree container.
     *
     * To generate the XBEL document the XbelParser uses the DOM API of Qt.
     */</span>
    <span class="keyword">class</span> XbelGenerator
    {
    <span class="keyword">public</span>:
        XbelGenerator(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>treeContainer);

        <span class="comment">// Starts the generation of the XBEL document</span>
        <span class="type">bool</span> write(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span> <span class="operator">*</span>device);

    <span class="keyword">private</span>:
        <span class="comment">// A helper method that generates an element in the XBEL document for a control</span>
        <span class="type">void</span> generateItem(bb<span class="operator">::</span>cascades<span class="operator">::</span>Control <span class="operator">*</span>item<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> <span class="operator">&amp;</span>parent<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomdocument.html">QDomDocument</a></span> <span class="operator">&amp;</span>domDocument);

        <span class="comment">// The container object the controls are located in</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpointer.html">QPointer</a></span><span class="operator">&lt;</span>bb<span class="operator">::</span>cascades<span class="operator">::</span>Container<span class="operator">&gt;</span> m_treeContainer;
    };</pre>
<a name="xbelgenerator-class-implementation"></a>
<h2>XbelGenerator Class Implementation</h2>
<p>The <tt>XbelGenerator</tt> constructor accepts a <i>treeContainer</i> to initialize within its definition.</p>
<pre class="cpp">    XbelGenerator<span class="operator">::</span>XbelGenerator(Container <span class="operator">*</span>treeContainer)
            : m_treeContainer(treeContainer)
    {
    }</pre>
<p>The <tt>write()</tt> method creates a <a href="http://qt.nokia.com/doc/4.7/qdomdocument.html">QDomDocument</a> instance and adds the processing instructions and top-level element for a valid XBEL document to it.</p>
<p>Afterwards it iterates recursively over the <tt>treeContainer</tt> to generate one DOM element for each child control of the container and append the element to the <a href="http://qt.nokia.com/doc/4.7/qdomdocument.html">QDomDocument</a>.</p>
<p>At the end <tt>write()</tt> creates a <a href="http://qt.nokia.com/doc/4.7/qtextstream.html">QTextStream</a> object on the passed in <a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a> and writes out the assembled DOM document to the stream.</p>
<pre class="cpp">    <span class="type">bool</span> XbelGenerator<span class="operator">::</span>write(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span> <span class="operator">*</span>device)
    {
        <span class="comment">// Create a new DOM document</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomdocument.html">QDomDocument</a></span> domDocument(<span class="string">&quot;xbel&quot;</span>);
        domDocument<span class="operator">.</span>appendChild(domDocument<span class="operator">.</span>createProcessingInstruction(<span class="string">&quot;xml&quot;</span><span class="operator">,</span> <span class="string">&quot;version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;&quot;</span>));

        <span class="comment">// Add the root element with the necessary 'xbel' element and version attribute</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> rootElement <span class="operator">=</span> domDocument<span class="operator">.</span>createElement(<span class="string">&quot;xbel&quot;</span>);
        rootElement<span class="operator">.</span>setAttribute(<span class="string">&quot;version&quot;</span><span class="operator">,</span> <span class="string">&quot;1.0&quot;</span>);
        domDocument<span class="operator">.</span>appendChild(rootElement);

        <span class="comment">// Iterate over the controls of the tree container and generate an XBEL element for each of them</span>
        <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> m_treeContainer<span class="operator">-</span><span class="operator">&gt;</span>count(); <span class="operator">+</span><span class="operator">+</span>i)
            generateItem(m_treeContainer<span class="operator">-</span><span class="operator">&gt;</span>at(i)<span class="operator">,</span> rootElement<span class="operator">,</span> domDocument);

        <span class="keyword">const</span> <span class="type">int</span> IndentWidth <span class="operator">=</span> <span class="number">4</span>;

        <span class="comment">// Use a text stream to write out the DOM document in a nicely formatted way</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qtextstream.html">QTextStream</a></span> stream(device);
        stream<span class="operator">.</span>setCodec(<span class="string">&quot;UTF-8&quot;</span>);
        domDocument<span class="operator">.</span>save(stream<span class="operator">,</span> IndentWidth);

        <span class="keyword">return</span> <span class="keyword">true</span>;
    }</pre>
<p>The <tt>generateItem()</tt> method accepts a Control object, the parent DOM element and the DOM document. It first extracts the type and the title from the control and then generates a new <a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a> object depending on the <tt>tagName</tt>, which can either be a 'folder', 'bookmark', or 'separator'. If the control is a Container it will call itself recursively.</p>
<pre class="cpp">    <span class="type">void</span> XbelGenerator<span class="operator">::</span>generateItem(Control <span class="operator">*</span>control<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> <span class="operator">&amp;</span>parent<span class="operator">,</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomdocument.html">QDomDocument</a></span> <span class="operator">&amp;</span>domDocument)
    {
        <span class="comment">/**
         * Retrieve the tag name and title from the control.
         * These two properties have been set on the controls by the XbelParser.
         */</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> tagName <span class="operator">=</span> control<span class="operator">-</span><span class="operator">&gt;</span>property(<span class="string">&quot;tagName&quot;</span>)<span class="operator">.</span>toString();
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> title <span class="operator">=</span> control<span class="operator">-</span><span class="operator">&gt;</span>property(<span class="string">&quot;title&quot;</span>)<span class="operator">.</span>toString();

        <span class="comment">// Depending on the tag name generate a new DOM element in the XBEL document</span>
        <span class="keyword">if</span> (tagName <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;folder&quot;</span>) {
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> folderElement <span class="operator">=</span> domDocument<span class="operator">.</span>createElement(<span class="string">&quot;folder&quot;</span>);
            folderElement<span class="operator">.</span>setAttribute(<span class="string">&quot;folded&quot;</span><span class="operator">,</span> <span class="string">&quot;no&quot;</span>);

            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> titleElement <span class="operator">=</span> domDocument<span class="operator">.</span>createElement(<span class="string">&quot;title&quot;</span>);
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomtext.html">QDomText</a></span> titleText <span class="operator">=</span> domDocument<span class="operator">.</span>createTextNode(title);
            titleElement<span class="operator">.</span>appendChild(titleText);
            folderElement<span class="operator">.</span>appendChild(titleElement);

            <span class="comment">// Iterate over the child controls of the container</span>
            <span class="keyword">const</span> Container <span class="operator">*</span>container <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>Container<span class="operator">*</span><span class="operator">&gt;</span>(control);
            <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> container<span class="operator">-</span><span class="operator">&gt;</span>count(); <span class="operator">+</span><span class="operator">+</span>i)
                generateItem(container<span class="operator">-</span><span class="operator">&gt;</span>at(i)<span class="operator">,</span> folderElement<span class="operator">,</span> domDocument);

            parent<span class="operator">.</span>appendChild(folderElement);
        } <span class="keyword">else</span> <span class="keyword">if</span> (tagName <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;bookmark&quot;</span>) {
            <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> url <span class="operator">=</span> control<span class="operator">-</span><span class="operator">&gt;</span>property(<span class="string">&quot;url&quot;</span>)<span class="operator">.</span>toString();

            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> bookmarkElement <span class="operator">=</span> domDocument<span class="operator">.</span>createElement(<span class="string">&quot;bookmark&quot;</span>);
            <span class="keyword">if</span> (<span class="operator">!</span>url<span class="operator">.</span>isEmpty())
                bookmarkElement<span class="operator">.</span>setAttribute(<span class="string">&quot;href&quot;</span><span class="operator">,</span> url);

            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> titleElement <span class="operator">=</span> domDocument<span class="operator">.</span>createElement(<span class="string">&quot;title&quot;</span>);
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomtext.html">QDomText</a></span> titleText <span class="operator">=</span> domDocument<span class="operator">.</span>createTextNode(title);
            titleElement<span class="operator">.</span>appendChild(titleText);
            bookmarkElement<span class="operator">.</span>appendChild(titleElement);

            parent<span class="operator">.</span>appendChild(bookmarkElement);
        } <span class="keyword">else</span> <span class="keyword">if</span> (tagName <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;separator&quot;</span>) {
            <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> separatorElement <span class="operator">=</span> domDocument<span class="operator">.</span>createElement(<span class="string">&quot;separator&quot;</span>);
            parent<span class="operator">.</span>appendChild(separatorElement);
        }
    }</pre>
<a name="xbelparser-class-definition"></a>
<h2>XbelParser Class Definition</h2>
<p>The <tt>XbelParser</tt> contains a reference to the Container that is used to group the bookmarks according to their hierarchy.</p>
<pre class="cpp">    <span class="comment">/**
     * The XbelParser is responsible for parsing a XBEL file and generating
     * controls, that represent the bookmark entries, on the tree container.
     *
     * To parse the XBEL document the XbelParser uses the DOM API of Qt.
     */</span>
    <span class="keyword">class</span> XbelParser
    {
    <span class="keyword">public</span>:
        XbelParser(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>treeContainer);

        <span class="comment">// Starts the parsing of the XBEL document</span>
        <span class="type">bool</span> parse(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span> <span class="operator">*</span>device);

        <span class="comment">// Returns a textual representation of the error if one occurred</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> errorString() <span class="keyword">const</span>;

    <span class="keyword">private</span>:
        <span class="comment">// A helper method that parses one XBEL folder element</span>
        <span class="type">void</span> parseFolderElement(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> <span class="operator">&amp;</span>element<span class="operator">,</span> bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

        <span class="comment">// A helper method that generates a control for a specific XBEL element</span>
        bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>createChildItem(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> <span class="operator">&amp;</span>element<span class="operator">,</span> bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

        <span class="comment">// The container object the controls are created in</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpointer.html">QPointer</a></span><span class="operator">&lt;</span>bb<span class="operator">::</span>cascades<span class="operator">::</span>Container<span class="operator">&gt;</span> m_treeContainer;

        <span class="comment">// The textual representation of an error</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> m_errorString;
    };</pre>
<a name="xbelparser-class-implementation"></a>
<h2>XbelParser Class Implementation</h2>
<p>The <tt>XbelParser</tt> constructor accepts a Container to initialize the <tt>treeContainer</tt> within its definition.</p>
<pre class="cpp">    XbelParser<span class="operator">::</span>XbelParser(Container <span class="operator">*</span>treeContainer)
        : m_treeContainer(treeContainer)
    {
    }</pre>
<p>The <tt>parse()</tt> method accepts a <a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a> and passes it to the <a href="http://qt.nokia.com/doc/4.7/qdomdocument.html#setContent">setContent()</a> method of the <a href="http://qt.nokia.com/doc/4.7/qdomdocument.html">QDomDocument</a>, which will cause the <a href="http://qt.nokia.com/doc/4.7/qdomdocument.html">QDomDocument</a> to build up the tree of <a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a> from the XML data.</p>
<p>We check then whether the XML data are a valid XBEL file by evaluating the tag name of the top-level element and the version number.</p>
<p>If it is a valid document we start to iterate over the 'folder' elements of the DOM document recursively and call <tt>parseFolderElement()</tt> on each of them.</p>
<pre class="cpp">    <span class="type">bool</span> XbelParser<span class="operator">::</span>parse(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span> <span class="operator">*</span>device)
    {
        <span class="comment">// Open a DOM document on the XBEL data and report an error if it fails</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> errorString;
        <span class="type">int</span> errorLine;
        <span class="type">int</span> errorColumn;

        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomdocument.html">QDomDocument</a></span> domDocument;
        <span class="keyword">if</span> (<span class="operator">!</span>domDocument<span class="operator">.</span>setContent(device<span class="operator">,</span> <span class="keyword">true</span><span class="operator">,</span> <span class="operator">&amp;</span>errorString<span class="operator">,</span> <span class="operator">&amp;</span>errorLine<span class="operator">,</span> <span class="operator">&amp;</span>errorColumn)) {
            m_errorString <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">::</span>tr(<span class="string">&quot;Parse error at line %1, column %2:\n%3&quot;</span>)<span class="operator">.</span>arg(errorLine)
                    <span class="operator">.</span>arg(errorColumn)
                    <span class="operator">.</span>arg(errorString);
            <span class="keyword">return</span> <span class="keyword">false</span>;
        }

        <span class="comment">// Check whether this is a valid XBEL file in the correct version</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> rootElement <span class="operator">=</span> domDocument<span class="operator">.</span>documentElement();
        <span class="keyword">if</span> (rootElement<span class="operator">.</span>tagName() <span class="operator">!</span><span class="operator">=</span> <span class="string">&quot;xbel&quot;</span>) {
            m_errorString <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">::</span>tr(<span class="string">&quot;The file is not an XBEL file.&quot;</span>);
            <span class="keyword">return</span> <span class="keyword">false</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (rootElement<span class="operator">.</span>hasAttribute(<span class="string">&quot;version&quot;</span>) <span class="operator">&amp;</span><span class="operator">&amp;</span> rootElement<span class="operator">.</span>attribute(<span class="string">&quot;version&quot;</span>) <span class="operator">!</span><span class="operator">=</span> <span class="string">&quot;1.0&quot;</span>) {
            m_errorString <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">::</span>tr(<span class="string">&quot;The file is not an XBEL version 1.0 file&quot;</span>);
            <span class="keyword">return</span> <span class="keyword">false</span>;
        }

        <span class="comment">// Search for the first &lt;folder&gt; element ...</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> child <span class="operator">=</span> rootElement<span class="operator">.</span>firstChildElement(<span class="string">&quot;folder&quot;</span>);
        <span class="keyword">while</span> (<span class="operator">!</span>child<span class="operator">.</span>isNull()) {
            <span class="comment">// ... parse this folder element ...</span>
            parseFolderElement(child);

            <span class="comment">// ... and search for the next one until the end of the XBEL document is reached</span>
            child <span class="operator">=</span> child<span class="operator">.</span>nextSiblingElement(<span class="string">&quot;folder&quot;</span>);
        }

        <span class="keyword">return</span> <span class="keyword">true</span>;
    }</pre>
<p>The <tt>errorString()</tt> function is used if an error occurred, in order to obtain a description of the error complete with line and column number information.</p>
<pre class="cpp">    <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> XbelParser<span class="operator">::</span>errorString() <span class="keyword">const</span>
    {
        <span class="keyword">return</span> m_errorString;
    }</pre>
<p>The <tt>parseFolderElement()</tt> method creates new <tt>Control</tt> object by calling the <tt>createChildItem()</tt> method. Afterwards it sets the properties of the control according to the content and attributes of the current DOM element. Then it iterates recursively over the child elements of the folder element.</p>
<pre class="cpp">    <span class="type">void</span> XbelParser<span class="operator">::</span>parseFolderElement(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> <span class="operator">&amp;</span>element<span class="operator">,</span> Container <span class="operator">*</span>parent)
    {
        <span class="comment">// Create a container that will contain all the child controls from this &lt;folder&gt; element</span>
        Container <span class="operator">*</span>item <span class="operator">=</span> createChildItem(element<span class="operator">,</span> parent);

        <span class="comment">// Read the title from the DOM document ...</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> title <span class="operator">=</span> element<span class="operator">.</span>firstChildElement(<span class="string">&quot;title&quot;</span>)<span class="operator">.</span>text();
        <span class="keyword">if</span> (title<span class="operator">.</span>isEmpty())
            title <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">::</span>tr(<span class="string">&quot;Folder&quot;</span>);

        <span class="comment">// ... and set it as 'title' property on the container</span>
        item<span class="operator">-</span><span class="operator">&gt;</span>setProperty(<span class="string">&quot;title&quot;</span><span class="operator">,</span> title);

        <span class="comment">// Iterate over the children of the &lt;folder&gt; element, read the properties and set them on the control</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> child <span class="operator">=</span> element<span class="operator">.</span>firstChildElement();
        <span class="keyword">while</span> (<span class="operator">!</span>child<span class="operator">.</span>isNull()) {
            <span class="keyword">if</span> (child<span class="operator">.</span>tagName() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;folder&quot;</span>) {
                parseFolderElement(child<span class="operator">,</span> item);
            } <span class="keyword">else</span> <span class="keyword">if</span> (child<span class="operator">.</span>tagName() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;bookmark&quot;</span>) {
                Container <span class="operator">*</span>childItem <span class="operator">=</span> createChildItem(child<span class="operator">,</span> item);

                <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> title <span class="operator">=</span> child<span class="operator">.</span>firstChildElement(<span class="string">&quot;title&quot;</span>)<span class="operator">.</span>text();
                <span class="keyword">if</span> (title<span class="operator">.</span>isEmpty())
                    title <span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">::</span>tr(<span class="string">&quot;Folder&quot;</span>);

                childItem<span class="operator">-</span><span class="operator">&gt;</span>setProperty(<span class="string">&quot;title&quot;</span><span class="operator">,</span> title);
                childItem<span class="operator">-</span><span class="operator">&gt;</span>setProperty(<span class="string">&quot;url&quot;</span><span class="operator">,</span> child<span class="operator">.</span>attribute(<span class="string">&quot;href&quot;</span>));
            } <span class="keyword">else</span> <span class="keyword">if</span> (child<span class="operator">.</span>tagName() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;separator&quot;</span>) {
                createChildItem(child<span class="operator">,</span> item);
            }
            child <span class="operator">=</span> child<span class="operator">.</span>nextSiblingElement();
        }
    }</pre>
<p>The <tt>createChildItem()</tt> method loads a QML file and returns the C++ object that represents the root node of the QML file. Depending on the current DOM element, different QML files are loaded.</p>
<pre class="cpp">    Container <span class="operator">*</span>XbelParser<span class="operator">::</span>createChildItem(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qdomelement.html">QDomElement</a></span> <span class="operator">&amp;</span>element<span class="operator">,</span> Container <span class="operator">*</span>parent)
    {
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> tagName <span class="operator">=</span> element<span class="operator">.</span>tagName();

        <span class="comment">// Use a different QML file depending on the requested XBEL element type</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> qmlFile <span class="operator">=</span> (tagName <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;folder&quot;</span> <span class="operator">?</span> <span class="string">&quot;asset:///FolderItem.qml&quot;</span> :
                                 tagName <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;bookmark&quot;</span> <span class="operator">?</span> <span class="string">&quot;asset:///BookmarkItem.qml&quot;</span> :
                                 tagName <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;separator&quot;</span> <span class="operator">?</span> <span class="string">&quot;asset:///SeparatorItem.qml&quot;</span> : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span>());

        Container <span class="operator">*</span>container <span class="operator">=</span> <span class="number">0</span>;

        <span class="comment">// Load the QML file ...</span>
        QmlDocument <span class="operator">*</span>qml <span class="operator">=</span> QmlDocument<span class="operator">::</span>create(qmlFile);
        <span class="keyword">if</span> (<span class="operator">!</span>qml<span class="operator">-</span><span class="operator">&gt;</span>hasErrors()) {
            <span class="comment">// ... create the top-level control ...</span>
            container <span class="operator">=</span> qml<span class="operator">-</span><span class="operator">&gt;</span>createRootObject<span class="operator">&lt;</span>Container<span class="operator">&gt;</span>();

            <span class="comment">// ... and add it to the parent container</span>
            <span class="keyword">if</span> (parent) {
                parent<span class="operator">-</span><span class="operator">&gt;</span>add(container);
            } <span class="keyword">else</span> {
                m_treeContainer<span class="operator">-</span><span class="operator">&gt;</span>add(container);
            }
        }

        <span class="keyword">return</span> container;
    }</pre>
<p>See the <a href="http://pyxml.sourceforge.net/topics/xbel/">XML Bookmark Exchange Language Resource Page</a> for more information about XBEL files.</p>
</div>
<!-- @@@dombookmarks -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Portions Copyright 2012 Research In Motion Limited.
     <acronym title="Copyright">&copy;</acronym> 2008-2011 Nokia Corporation and/or its
     subsidiaries. Nokia, Qt and their respective logos are trademarks of Nokia Corporation 
     in Finland and/or other countries worldwide.</p>
  <p>
     All other trademarks are property of their respective owners. <a title="Privacy Policy"
     href="http://qt.nokia.com/about/privacy-policy">Privacy Policy</a></p>
  <br />
  <p>
    Licensees holding valid Qt Commercial licenses may use this document in accordance with the    Qt Commercial License Agreement provided with the Software or, alternatively, in accordance    with the terms contained in a written agreement between you and Nokia.</p>
  <p>
    Alternatively, this document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
