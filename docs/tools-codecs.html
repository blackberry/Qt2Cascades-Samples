<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- codecs.qdoc -->
  <title>Cascades : Codecs Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt with Cascades UI Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#codeccontroller">CodecController</a></li>
</ul>
</div>
<h1 class="title">Codecs Example</h1>
<span class="subtitle"></span>
<!-- $$$tools/codecs-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="tools-codecs-assets-main-qml.html">tools/codecs/assets/main.qml</a></li>
<li><a href="tools-codecs-src-codeccontroller-cpp.html">tools/codecs/src/CodecController.cpp</a></li>
<li><a href="tools-codecs-src-codeccontroller-hpp.html">tools/codecs/src/CodecController.hpp</a></li>
<li><a href="tools-codecs-src-main-cpp.html">tools/codecs/src/main.cpp</a></li>
<li><a href="tools-codecs-codecs-pro.html">tools/codecs/codecs.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The Codecs example demonstrates the principles behind importing text using codecs to ensure that characters are encoded properly, avoiding loss of data and retaining the correct symbols used in various scripts.</p>
<p class="centerAlign"><img src="images/codecs-example.png" alt="" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the QTextCodec class to decode raw data from a file and show them on the screen.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The sample application provides an UI with two DropDown controls in a row to select a file and a codec and below a TextArea where the decoded content of the selected file is shown. All the business logic is encapsulated in the C++ class CodecController which has been exported to the UI under the name '<a href="#codeccontroller">_codecController</a>'.</p>
<pre class="qml">                    <span class="type">DropDown</span> {
                        <span class="name">id</span>: <span class="name">fileList</span>
                        <span class="name">title</span>: <span class="name">qsTr</span> (<span class="string">&quot;File&quot;</span>)

                        <span class="name">onSelectedIndexChanged</span>: {
                            <span class="comment">// Trigger an update of the decoded file content</span>
                            <span class="name">_codecController</span>.<span class="name">updateFileContent</span>()
                        }
                    }

                    <span class="type">DropDown</span> {
                        <span class="name">id</span>: <span class="name">codecList</span>
                        <span class="name">title</span>: <span class="name">qsTr</span> (<span class="string">&quot;Codec&quot;</span>)

                        <span class="name">onSelectedIndexChanged</span>: {
                            <span class="comment">// Trigger an update of the decoded file content</span>
                            <span class="name">_codecController</span>.<span class="name">updateFileContent</span>()
                        }
                    }</pre>
<p>Whenever the user selects a file or a codec from the DropDown controls, the updateFileContent() slot of the CodecController is invoked to update the content of the TextArea.</p>
<pre class="qml">            <span class="name">onCreationCompleted</span>: {
                <span class="comment">// Tell the CodecController which DropDowns will handle the file and codec list</span>
                <span class="name">_codecController</span>.<span class="name">fileList</span> <span class="operator">=</span> <span class="name">fileList</span>
                <span class="name">_codecController</span>.<span class="name">codecList</span> <span class="operator">=</span> <span class="name">codecList</span>
            }</pre>
<p>Since the CodecController is also responsible for filling the DropDown controls with the list of available files and codecs, we have to set the 'fileList' and 'codecList' properties of the CodecController. This is done inside the signal handler for the creationCompleted() signal, which is emitted after the top-level control in main.qml has been created and initialized.</p>
<pre class="qml">                <span class="comment">// Shows the decoded file content</span>
                <span class="type">TextArea</span> {
                    <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>

                    <span class="name">layoutProperties</span>: <span class="name">StackLayoutProperties</span> {
                        <span class="name">spaceQuota</span>: <span class="number">1</span>
                    }

                    <span class="name">text</span>: <span class="name">_codecController</span>.<span class="name">fileContent</span>
                    <span class="name">hintText</span>: <span class="string">&quot;&quot;</span>
                }</pre>
<p>The CodecController also provides the property 'fileContent' which contains the content of the currently selected file decoded with the currently selected codec or an empty string if no file has been selected. We simply bind that property against the 'text' property of the TextArea.</p>
<a name="codeccontroller"></a>
<h2>CodecController</h2>
<p>When the UI is loaded and the file selection DropDown is assigned to the 'fileList' property of the CodecController, the fillFileList() method is called which fills the provided DropDown with the entries for all available files. As the text of the entries we use the base name of the files and as value the relative path.</p>
<pre class="cpp">    <span class="type">void</span> CodecController<span class="operator">::</span>fillFileList()
    {
        <span class="keyword">if</span> (<span class="operator">!</span>m_fileList)
            <span class="keyword">return</span>;

        <span class="keyword">const</span> <span class="type">QStringList</span> fileNames <span class="operator">=</span> <span class="type">QStringList</span>()
            <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;iso-8859-1.txt&quot;</span>
            <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;iso-8859-15.txt&quot;</span>
            <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;utf-16.txt&quot;</span>
            <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;utf-16be.txt&quot;</span>
            <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;utf-16le.txt&quot;</span>
            <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;utf-8.txt&quot;</span>;

        <span class="comment">// Clear the file DropDown</span>
        m_fileList<span class="operator">-</span><span class="operator">&gt;</span>removeAll();

        <span class="comment">// Create one entry for each file</span>
        foreach (<span class="keyword">const</span> <span class="type">QString</span> fileName<span class="operator">,</span> fileNames) {
            Option <span class="operator">*</span>option <span class="operator">=</span> <span class="keyword">new</span> Option;
            option<span class="operator">-</span><span class="operator">&gt;</span>setText(fileName);
            option<span class="operator">-</span><span class="operator">&gt;</span>setValue(<span class="type">QString</span>(<span class="string">&quot;app/native/assets/encodedfiles/%1&quot;</span>)<span class="operator">.</span>arg(fileName));
            m_fileList<span class="operator">-</span><span class="operator">&gt;</span>add(option);
        }
    }</pre>
<p>This list is hard-coded to the list of files that are located in the assets/encodedfiles/ directory in the project folder.</p>
<p>When the codec selection DropDown is assigned to the 'codecList' property, the fillCodecList() method is called.</p>
<pre class="cpp">    <span class="type">void</span> CodecController<span class="operator">::</span>fillCodecList()
    {
        <span class="keyword">if</span> (<span class="operator">!</span>m_codecList)
            <span class="keyword">return</span>;

        <span class="comment">// Clear the codec DropDown</span>
        m_codecList<span class="operator">-</span><span class="operator">&gt;</span>removeAll();

        <span class="comment">// Create one entry for each codec available on the system</span>
        foreach (<span class="type">int</span> mib<span class="operator">,</span> <span class="type">QTextCodec</span><span class="operator">::</span>availableMibs()) {
            <span class="type">QTextCodec</span> <span class="operator">*</span>codec <span class="operator">=</span> <span class="type">QTextCodec</span><span class="operator">::</span>codecForMib(mib);

            Option <span class="operator">*</span>option <span class="operator">=</span> <span class="keyword">new</span> Option;
            option<span class="operator">-</span><span class="operator">&gt;</span>setText(codec<span class="operator">-</span><span class="operator">&gt;</span>name());
            option<span class="operator">-</span><span class="operator">&gt;</span>setValue(<span class="type">QVariant</span><span class="operator">::</span>fromValue(codec));

            <span class="comment">// pre-select the UTF-8 codec in the DropDown</span>
            <span class="keyword">if</span> (codec<span class="operator">-</span><span class="operator">&gt;</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;UTF-8&quot;</span>)
                option<span class="operator">-</span><span class="operator">&gt;</span>setSelected(<span class="keyword">true</span>);

            m_codecList<span class="operator">-</span><span class="operator">&gt;</span>add(option);
        }
    }</pre>
<p>Here we iterate over the list of available codecs that are provided by Qt on this system and add one entry to the DropDown for each codec. As text for the entry we use the codec name and as value the pointer to the actual QTextCodec object that represents this codec. In addition we preselect the UTF-8 codec.</p>
<p>When the user selects a file or codec from the DropDown controls, the updateFileContent() slot will be invoked:</p>
<pre class="cpp">    <span class="type">void</span> CodecController<span class="operator">::</span>updateFileContent()
    {
        <span class="keyword">if</span> (<span class="operator">!</span>m_fileList <span class="operator">|</span><span class="operator">|</span> <span class="operator">!</span>m_codecList)
            <span class="keyword">return</span>;

        <span class="comment">// Check whether the user has selected a file already</span>
        <span class="keyword">const</span> <span class="type">int</span> selectedIndex <span class="operator">=</span> m_fileList<span class="operator">-</span><span class="operator">&gt;</span>selectedIndex();
        <span class="keyword">if</span> (selectedIndex <span class="operator">=</span><span class="operator">=</span> DropDown<span class="operator">::</span>SelectedIndexNone)
            <span class="keyword">return</span>;

        <span class="comment">// Retrieve the selected Options from the file and codec DropDowns</span>
        <span class="keyword">const</span> Option <span class="operator">*</span>selectedFileOption <span class="operator">=</span> m_fileList<span class="operator">-</span><span class="operator">&gt;</span>at(selectedIndex);
        <span class="keyword">const</span> Option <span class="operator">*</span>selectedCodecOption <span class="operator">=</span> m_codecList<span class="operator">-</span><span class="operator">&gt;</span>at(m_codecList<span class="operator">-</span><span class="operator">&gt;</span>selectedIndex());

        <span class="comment">// Extract the values associated with the selected Options</span>
        <span class="keyword">const</span> <span class="type">QString</span> fileName <span class="operator">=</span> selectedFileOption<span class="operator">-</span><span class="operator">&gt;</span>value()<span class="operator">.</span>toString();
        <span class="type">QTextCodec</span> <span class="operator">*</span>codec <span class="operator">=</span> selectedCodecOption<span class="operator">-</span><span class="operator">&gt;</span>value()<span class="operator">.</span>value<span class="operator">&lt;</span><span class="type">QTextCodec</span><span class="operator">*</span><span class="operator">&gt;</span>();

        <span class="comment">// Open the selected file ...</span>
        <span class="type">QFile</span> file(fileName);
        <span class="keyword">if</span> (<span class="operator">!</span>file<span class="operator">.</span>open(<span class="type">QIODevice</span><span class="operator">::</span>ReadOnly))
            <span class="keyword">return</span>;

        <span class="comment">// ... set a QTextStream with the selected codec on it ...</span>
        <span class="type">QTextStream</span> stream(<span class="operator">&amp;</span>file);
        stream<span class="operator">.</span>setAutoDetectUnicode(<span class="keyword">false</span>);
        stream<span class="operator">.</span>setCodec(codec);

        <span class="comment">// ... and read out the decoded content</span>
        m_fileContent <span class="operator">=</span> stream<span class="operator">.</span>readAll();

        <span class="keyword">emit</span> fileContentChanged();
    }</pre>
<p>In this method we first check which file and codec the user has selected in the DropDown controls and extract the file path and the QTextCodec object from the Option objects. Afterwards we try to open the selected file and set a QTextStream on it. The QTextStream allows us to read data from the file and decode them on-the-fly. For that we have to tell QTextStream which codec should be used, which is done by calling setCodec() on it.</p>
<p>Now we read the complete content of the file into the 'fileContent' property and emit the change notification signal, so that the UI will update the content of the TextArea.</p>
</div>
<!-- @@@tools/codecs -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Portions Copyright 2012 Research In Motion Limited.
     <acronym title="Copyright">&copy;</acronym> 2008-2011 Nokia Corporation and/or its
     subsidiaries. Nokia, Qt and their respective logos are trademarks of Nokia Corporation 
     in Finland and/or other countries worldwide.</p>
  <p>
     All other trademarks are property of their respective owners. <a title="Privacy Policy"
     href="http://qt.nokia.com/about/privacy-policy">Privacy Policy</a></p>
  <br />
  <p>
    Licensees holding valid Qt Commercial licenses may use this document in accordance with the    Qt Commercial License Agreement provided with the Software or, alternatively, in accordance    with the terms contained in a written agreement between you and Nokia.</p>
  <p>
    Alternatively, this document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
