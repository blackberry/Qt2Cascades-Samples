<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- rsslisting.qdoc -->
  <title>Cascades : RSS-Listing Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt with Cascades UI Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li><a href="http://qt.nokia.com/doc/4.7/all-examples.html">Examples</a></li>
<li>RSS-Listing Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#rsslisting">RSSListing</a></li>
</ul>
</div>
<h1 class="title">RSS-Listing Example</h1>
<span class="subtitle"></span>
<!-- $$$rsslisting-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="rsslisting-assets-main-qml.html">rsslisting/assets/main.qml</a></li>
<li><a href="rsslisting-src-rsslisting-cpp.html">rsslisting/src/rsslisting.cpp</a></li>
<li><a href="rsslisting-src-rsslisting-hpp.html">rsslisting/src/rsslisting.hpp</a></li>
<li><a href="rsslisting-src-main-cpp.html">rsslisting/src/main.cpp</a></li>
<li><a href="rsslisting-rsslisting-pro.html">rsslisting/rsslisting.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>This example shows how to create an UI that displays news items from RDF news sources.</p>
<p class="centerAlign"><img src="images/rsslisting-example.png" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the <a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html">QNetworkAccessManager</a> class to download a RSS news feed from the network and how to use <a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html">QXmlStreamReader</a> to parse the feed and extract information from it.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The sample application provides an UI where the user can enter the URL for a RSS news feed, a button the user can click to start the download of the news feed and a text area where the downloaded items are listed with title and URL.</p>
<p>All the business logic is encapsulated in the C++ class RSSListing which has been exported to the UI under the name '<a href="#rsslisting">_rssListing</a>'.</p>
<pre class="qml">                <span class="comment">// A standard TextField for the RSS url</span>
                <span class="type">TextField</span> {
                    <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>

                    <span class="name">layoutProperties</span>: <span class="name">StackLayoutProperties</span> {
                        <span class="name">spaceQuota</span>: <span class="number">1</span>
                    }

                    <span class="name">enabled</span>: ! <span class="name">_rssListing</span>.<span class="name">active</span>

                    <span class="name">text</span>: <span class="name">_rssListing</span>.<span class="name">url</span>

                    <span class="comment">// Save url on input</span>
                    <span class="name">onTextChanging</span>: <span class="name">_rssListing</span>.<span class="name">url</span> <span class="operator">=</span> <span class="name">text</span>
                }</pre>
<p>The TextField, where the user can enter the URL of the RSS news feed, binds against the 'url' property of the RSSListing object and updates this property whenever the user changes the text. The field will be disabled while a download operation is running and the 'active' property of the RSSListing object is true.</p>
<pre class="qml">                <span class="comment">// A standard Button</span>
                <span class="type">Button</span> {
                    <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>
                    <span class="name">leftMargin</span>: <span class="number">10</span>

                    <span class="name">layoutProperties</span>: <span class="name">StackLayoutProperties</span> {
                        <span class="name">spaceQuota</span>: -<span class="number">1</span>
                    }

                    <span class="name">enabled</span>: ! <span class="name">_rssListing</span>.<span class="name">active</span>

                    <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;Fetch&quot;</span>)

                    <span class="comment">// Fetch news items on click</span>
                    <span class="name">onClicked</span>: <span class="name">_rssListing</span>.<span class="name">fetch</span> ()
                }</pre>
<p>The 'Fetch' button will invoke the fetch() slot of the RSSListing object when the user clicks it. Like the URL input field, the button will be disabled while a download operation is running.</p>
<pre class="qml">                <span class="comment">// A standard TextArea for displaying items</span>
                <span class="type">TextArea</span> {
                    <span class="name">editable</span>: <span class="number">false</span>

                    <span class="name">text</span>: <span class="name">_rssListing</span>.<span class="name">feeds</span>
                    <span class="type">textStyle</span> {
                        <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">SmallText</span>
                        <span class="name">color</span>: <span class="name">Color</span>.<span class="name">Black</span>
                    }
                }</pre>
<p>The TextArea binds the 'feeds' property of the RSSListing object against its 'text' property to show the listing of extracted titles and URLs.</p>
<a name="rsslisting"></a>
<h2>RSSListing</h2>
<p>The RSSListing class encapsulates the downloading of the RSS news feed and the extraction of information by parsing the XML data. It contains a <a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html">QNetworkAccessManager</a> and a QXmlStreamParser as member variables which will do the low-level network communication and parsing.</p>
<pre class="cpp">    RSSListing<span class="operator">::</span>RSSListing(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span> <span class="operator">*</span>parent)
        : <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span>(parent)
        <span class="operator">,</span> m_url(<span class="string">&quot;http://feeds.feedburner.com/blackberry/CAxx&quot;</span>)
        <span class="operator">,</span> m_active(<span class="keyword">false</span>)
        <span class="operator">,</span> m_currentReply(<span class="number">0</span>)
    {
        <span class="comment">// Invoke the finished() method whenever the download job has been finished</span>
        connect(<span class="operator">&amp;</span>m_manager<span class="operator">,</span> SIGNAL(finished(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a></span><span class="operator">*</span>))<span class="operator">,</span>
                <span class="keyword">this</span><span class="operator">,</span> SLOT(finished(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a></span><span class="operator">*</span>)));
    }</pre>
<p>In the constructor we connect the <a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html#finished">finished()</a> signal of the <a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html">QNetworkAccessManager</a> against the finished() slot of the RSSListing object, so that we can start the parsing of the XML data when the download of the feed has been finished.</p>
<p>When the user clicks the 'Fetch' button, the fetch() slot will be invoked which calls get() internally:</p>
<pre class="cpp">    <span class="type">void</span> RSSListing<span class="operator">::</span>get(<span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qurl.html">QUrl</a></span> <span class="operator">&amp;</span>url)
    {
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkrequest.html">QNetworkRequest</a></span> request(url);
        <span class="keyword">if</span> (m_currentReply) {
            m_currentReply<span class="operator">-</span><span class="operator">&gt;</span>disconnect(<span class="keyword">this</span>);
            m_currentReply<span class="operator">-</span><span class="operator">&gt;</span>deleteLater();
        }

        m_currentReply <span class="operator">=</span> m_manager<span class="operator">.</span>get(request);
        connect(m_currentReply<span class="operator">,</span> SIGNAL(readyRead())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(readyRead()));
        connect(m_currentReply<span class="operator">,</span> SIGNAL(metaDataChanged())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(metaDataChanged()));
        connect(m_currentReply<span class="operator">,</span> SIGNAL(error(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a></span><span class="operator">::</span>NetworkError))<span class="operator">,</span>
                <span class="keyword">this</span><span class="operator">,</span> SLOT(error(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a></span><span class="operator">::</span>NetworkError)));
    }</pre>
<p>Inside this method a new download request is passed to the <a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html#get">get()</a> method of the <a href="http://qt.nokia.com/doc/4.7/qnetworkaccessmanager.html">QNetworkAccessManager</a> with the URL as parameter that the user entered in the TextField in the UI. The return value is a <a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a> object that acts as handle to monitor the status and progress of the download operation.</p>
<p>We connect the <a href="http://qt.nokia.com/doc/4.7/qiodevice.html#readyRead">readyRead()</a> signal of the <a href="http://qt.nokia.com/doc/4.7/qnetworkreply.html">QNetworkReply</a> against our own slot to be informed whenever new data are available from the network</p>
<pre class="cpp">    <span class="type">void</span> RSSListing<span class="operator">::</span>readyRead()
    {
        <span class="keyword">const</span> <span class="type">int</span> statusCode <span class="operator">=</span> m_currentReply<span class="operator">-</span><span class="operator">&gt;</span>attribute(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qnetworkrequest.html">QNetworkRequest</a></span><span class="operator">::</span>HttpStatusCodeAttribute)<span class="operator">.</span>toInt();
        <span class="keyword">if</span> (statusCode <span class="operator">&gt;</span><span class="operator">=</span> <span class="number">200</span> <span class="operator">&amp;</span><span class="operator">&amp;</span> statusCode <span class="operator">&lt;</span> <span class="number">300</span>) {
            <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qbytearray.html">QByteArray</a></span> data <span class="operator">=</span> m_currentReply<span class="operator">-</span><span class="operator">&gt;</span>readAll();
            m_xml<span class="operator">.</span>addData(data);
        }
    }</pre>
<p>Whenever readyRead() is invoked, we read all available data from the network and pass them to the <a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html">QXmlStreamReader</a> instance.</p>
<pre class="cpp">    <span class="type">void</span> RSSListing<span class="operator">::</span>parseXml()
    {
        m_feeds<span class="operator">.</span>clear();

        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> currentTag;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> linkString;
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> titleString;

        <span class="keyword">while</span> (<span class="operator">!</span>m_xml<span class="operator">.</span>atEnd()) {
            m_xml<span class="operator">.</span>readNext();
            <span class="keyword">if</span> (m_xml<span class="operator">.</span>isStartElement()) {
                <span class="keyword">if</span> (m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;item&quot;</span>)
                    linkString <span class="operator">=</span> m_xml<span class="operator">.</span>attributes()<span class="operator">.</span>value(<span class="string">&quot;rss:about&quot;</span>)<span class="operator">.</span>toString();
                currentTag <span class="operator">=</span> m_xml<span class="operator">.</span>name()<span class="operator">.</span>toString();
            } <span class="keyword">else</span> <span class="keyword">if</span> (m_xml<span class="operator">.</span>isEndElement()) {
                <span class="keyword">if</span> (m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;item&quot;</span>) {

                    m_feeds<span class="operator">.</span>append(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(<span class="string">&quot;%1\n      %2\n\n&quot;</span>)<span class="operator">.</span>arg(titleString<span class="operator">,</span> linkString));

                    titleString<span class="operator">.</span>clear();
                    linkString<span class="operator">.</span>clear();
                }

            } <span class="keyword">else</span> <span class="keyword">if</span> (m_xml<span class="operator">.</span>isCharacters() <span class="operator">&amp;</span><span class="operator">&amp;</span> <span class="operator">!</span>m_xml<span class="operator">.</span>isWhitespace()) {
                <span class="keyword">if</span> (currentTag <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;title&quot;</span>)
                    titleString <span class="operator">+</span><span class="operator">=</span> m_xml<span class="operator">.</span>text()<span class="operator">.</span>toString();
                <span class="keyword">else</span> <span class="keyword">if</span> (currentTag <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;link&quot;</span>)
                    linkString <span class="operator">+</span><span class="operator">=</span> m_xml<span class="operator">.</span>text()<span class="operator">.</span>toString();
            }
        }

        <span class="keyword">if</span> (m_xml<span class="operator">.</span>error() <span class="operator">&amp;</span><span class="operator">&amp;</span> m_xml<span class="operator">.</span>error() <span class="operator">!</span><span class="operator">=</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html">QXmlStreamReader</a></span><span class="operator">::</span>PrematureEndOfDocumentError) {
            m_feeds<span class="operator">.</span>append(
                    <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span><span class="operator">::</span>fromLatin1(<span class="string">&quot;XML ERROR: %1: %2&quot;</span>)<span class="operator">.</span>arg(m_xml<span class="operator">.</span>lineNumber())<span class="operator">.</span>arg(m_xml<span class="operator">.</span>errorString()));
        }

        <span class="keyword">emit</span> feedsChanged();
    }</pre>
<p>After the download operation has finished, the parseXml() method is called. This one parses the downloaded XML data and extracts the title and URL information and makes them available to the UI via the 'feeds' property.</p>
</div>
<!-- @@@rsslisting -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Portions Copyright 2012 Research In Motion Limited.
     <acronym title="Copyright">&copy;</acronym> 2008-2011 Nokia Corporation and/or its
     subsidiaries. Nokia, Qt and their respective logos are trademarks of Nokia Corporation 
     in Finland and/or other countries worldwide.</p>
  <p>
     All other trademarks are property of their respective owners. <a title="Privacy Policy"
     href="http://qt.nokia.com/about/privacy-policy">Privacy Policy</a></p>
  <br />
  <p>
    Licensees holding valid Qt Commercial licenses may use this document in accordance with the    Qt Commercial License Agreement provided with the Software or, alternatively, in accordance    with the terms contained in a written agreement between you and Nokia.</p>
  <p>
    Alternatively, this document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
