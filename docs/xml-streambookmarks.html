<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- streambookmarks.qdoc -->
  <title>Cascades : QXmlStream Bookmarks Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt with Cascades UI Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#app">App</a></li>
<li class="level1"><a href="#xbelwriter-class-definition">XbelWriter Class Definition</a></li>
<li class="level1"><a href="#xbelwriter-class-implementation">XbelWriter Class Implementation</a></li>
<li class="level1"><a href="#xbelreader-class-definition">XbelReader Class Definition</a></li>
<li class="level1"><a href="#xbelreader-class-implementation">XbelReader Class Implementation</a></li>
</ul>
</div>
<h1 class="title">QXmlStream Bookmarks Example</h1>
<span class="subtitle"></span>
<!-- $$$xml/streambookmarks-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="xml-streambookmarks-assets-bookmarkitem-qml.html">xml/streambookmarks/assets/BookmarkItem.qml</a></li>
<li><a href="xml-streambookmarks-assets-folderitem-qml.html">xml/streambookmarks/assets/FolderItem.qml</a></li>
<li><a href="xml-streambookmarks-assets-separatoritem-qml.html">xml/streambookmarks/assets/SeparatorItem.qml</a></li>
<li><a href="xml-streambookmarks-assets-main-qml.html">xml/streambookmarks/assets/main.qml</a></li>
<li><a href="xml-streambookmarks-src-app-cpp.html">xml/streambookmarks/src/app.cpp</a></li>
<li><a href="xml-streambookmarks-src-app-hpp.html">xml/streambookmarks/src/app.hpp</a></li>
<li><a href="xml-streambookmarks-src-xbelreader-cpp.html">xml/streambookmarks/src/xbelreader.cpp</a></li>
<li><a href="xml-streambookmarks-src-xbelreader-hpp.html">xml/streambookmarks/src/xbelreader.hpp</a></li>
<li><a href="xml-streambookmarks-src-xbelwriter-cpp.html">xml/streambookmarks/src/xbelwriter.cpp</a></li>
<li><a href="xml-streambookmarks-src-xbelwriter-hpp.html">xml/streambookmarks/src/xbelwriter.hpp</a></li>
<li><a href="xml-streambookmarks-src-main-cpp.html">xml/streambookmarks/src/main.cpp</a></li>
<li><a href="xml-streambookmarks-streambookmarks-pro.html">xml/streambookmarks/streambookmarks.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The QXmlStream Bookmarks example provides a reader for XML Bookmark Exchange Language (XBEL) files using Qt's QXmlStreamReader class for reading, and QXmlStreamWriter class for writing the files.</p>
<p class="centerAlign"><img src="images/streambookmarks-example.png" alt="" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the QXmlStreamReader and QXmlStreamWriter classes to parse, modify and generate an XML document. Additionally we'll see how to generate UI objects (that are described in a QML file) on-the-fly and how to access and modify their properties.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The UI of this sample application consists of three buttons and a container. The first two buttons allow the user to load two different XBEL documents and the third button allows the user to save the currently loaded XBEL document back to file system (including possible changes done to the bookmarks).</p>
<p>The container is the target location for the tree of controls, that visualize the structure of the XBEL document. The XBEL standard defines the elements</p>
<ul>
<li>folder</li>
<li>bookmark</li>
<li>separator</li>
</ul>
<p>The folder is represented by a <tt>Container</tt> with a folder icon and a title label (FolderItem.qml). It provides a custom property 'tagName' and a property 'title' that is aliased to the 'text' property of the <tt>titleField</tt> label. So whenever the 'title' property is changed, the 'text' property will be updated.</p>
<pre class="qml">    <span class="comment">// Container for the visual representation of a XBEL folder element</span>
    <span class="type">Container</span> {
        property <span class="type">string</span> <span class="name">tagName</span>: <span class="string">&quot;folder&quot;</span>
        property <span class="type">alias</span> <span class="name">title</span>: <span class="name">titleField</span>.<span class="name">text</span>

        <span class="name">topMargin</span>: <span class="number">20</span>
        <span class="name">leftPadding</span>: <span class="number">20</span>

        <span class="type">Container</span> {
            <span class="name">layout</span>: <span class="name">StackLayout</span> {
                <span class="name">orientation</span>: <span class="name">LayoutOrientation</span>.<span class="name">LeftToRight</span>
            }

            <span class="comment">// A standard ImageView</span>
            <span class="type">ImageView</span> {
                <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/folder.png&quot;</span>
                <span class="name">preferredWidth</span>: <span class="number">32</span>
                <span class="name">preferredHeight</span>: <span class="number">32</span>
            }

            <span class="comment">// A standard Label for the folder title element</span>
            <span class="type">Label</span> {
                <span class="name">id</span>: <span class="name">titleField</span>
                <span class="name">leftMargin</span>: <span class="number">10</span>

                <span class="comment">// Defines custom text style</span>
                <span class="type">textStyle</span> {
                    <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">SmallText</span>
                    <span class="name">fontWeight</span>: <span class="name">FontWeight</span>.<span class="name">Bold</span>
                    <span class="name">color</span>: <span class="name">Color</span>.<span class="name">White</span>
                }
            }
        }
    }</pre>
<p>The bookmarks are visualized by a <tt>Container</tt> with a star icon, a title label and a <tt>TextField</tt> that contains the bookmark URL (BookmarkItem.qml). The <tt>TextField</tt> is invisible by default and will be faded in when the user clicks on the title label.</p>
<pre class="qml">    <span class="comment">// Container for the visual representation of a XBEL bookmark element</span>
    <span class="type">Container</span> {
        property <span class="type">string</span> <span class="name">tagName</span>: <span class="string">&quot;bookmark&quot;</span>
        property <span class="type">alias</span> <span class="name">title</span>: <span class="name">titleField</span>.<span class="name">text</span>
        property <span class="type">alias</span> <span class="name">url</span>: <span class="name">urlField</span>.<span class="name">text</span>

        <span class="name">topMargin</span>: <span class="number">10</span>
        <span class="name">leftMargin</span>: <span class="number">20</span>
        <span class="name">leftPadding</span>: <span class="number">20</span>

        <span class="type">Container</span> {
            <span class="name">layout</span>: <span class="name">StackLayout</span> {
                <span class="name">orientation</span>: <span class="name">LayoutOrientation</span>.<span class="name">LeftToRight</span>
            }

            <span class="comment">// A standard ImageView</span>
            <span class="type">ImageView</span> {
                <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>
                <span class="name">minWidth</span>: <span class="number">82</span>
                <span class="name">minHeight</span>: <span class="number">62</span>

                <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/bookmark.png&quot;</span>
                <span class="name">scalingMethod</span>: <span class="name">ScalingMethod</span>.<span class="name">AspectFit</span>
            }

            <span class="comment">// A standard Label for the bookmark title element</span>
            <span class="type">Label</span> {
                <span class="name">id</span>: <span class="name">titleField</span>

                <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>
                <span class="name">leftMargin</span>: <span class="number">10</span>

                <span class="type">textStyle</span> {
                    <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">SmallText</span>
                    <span class="name">color</span>: <span class="name">Color</span>.<span class="name">White</span>
                }

                <span class="name">onTouch</span>: {
                    <span class="keyword">if</span> (<span class="name">event</span>.<span class="name">isDown</span>()) {
                        <span class="name">urlField</span>.<span class="name">visible</span> <span class="operator">=</span> !<span class="name">urlField</span>.<span class="name">visible</span>
                    }
                }
            }
        }

        <span class="comment">// A standard TextField for the bookmark url attribute value</span>
        <span class="type">TextField</span> {
            <span class="name">id</span>: <span class="name">urlField</span>

            <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>
            <span class="name">leftMargin</span>: <span class="number">10</span>
            <span class="name">visible</span>: <span class="number">false</span>

            <span class="type">textStyle</span> {
                <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">SmallText</span>
            }
        }
    }</pre>
<p>A separator is an image of a horizontal line (SeparatorItem.qml).</p>
<pre class="qml">    <span class="comment">// Container used to create a separator black visual line</span>
    <span class="type">Container</span> {
        property <span class="type">string</span> <span class="name">tagName</span>: <span class="string">&quot;separator&quot;</span>

        <span class="name">topMargin</span>: <span class="number">20</span>
        <span class="name">leftPadding</span>: <span class="number">40</span>
        <span class="name">rightPadding</span>: <span class="number">20</span>

        <span class="type">ImageView</span> {
            <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Fill</span>

            <span class="name">imageSource</span>: <span class="string">&quot;asset:///images/separator.png&quot;</span>
        }
    }</pre>
<p>The business logic of the application is encapsulated in the class App, which is exported to the UI as '<a href="#app">_app</a>'.</p>
<pre class="qml">                    <span class="comment">// A standard Button</span>
                    <span class="type">Button</span> {
                        <span class="name">id</span>: <span class="name">frank</span>
                        <span class="name">layoutProperties</span>: <span class="name">StackLayoutProperties</span> {
                            <span class="name">spaceQuota</span>: <span class="number">1</span>
                        }

                        <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;Frank&quot;</span>)

                        <span class="comment">// Load the selected xbel file on click</span>
                        <span class="name">onClicked</span>: {
                            <span class="name">jennifer</span>.<span class="name">opacity</span> <span class="operator">=</span> <span class="number">0.5</span>;
                            <span class="name">save</span>.<span class="name">opacity</span> <span class="operator">=</span> <span class="number">0.5</span>;
                            <span class="name">frank</span>.<span class="name">opacity</span> <span class="operator">=</span> <span class="number">1.0</span>;
                            <span class="name">_app</span>.<span class="name">load</span> (<span class="string">&quot;frank.xbel&quot;</span>);
                        }
                    }</pre>
<p>Whenever the user clicks one of the load buttons, the <tt>load()</tt> method of the App object is invoked.</p>
<pre class="qml">                    <span class="comment">// A standard Button</span>
                    <span class="type">Button</span> {
                        <span class="name">id</span>: <span class="name">save</span>
                        <span class="name">layoutProperties</span>: <span class="name">StackLayoutProperties</span> {
                            <span class="name">spaceQuota</span>: <span class="number">1</span>
                        }

                        <span class="name">text</span>: <span class="name">qsTr</span> (<span class="string">&quot;Save&quot;</span>)

                        <span class="comment">// Save the changes to a temporary xbel file in the</span>
                        <span class="comment">// application tmp/ directory</span>
                        <span class="name">onClicked</span>: {
                            <span class="name">frank</span>.<span class="name">opacity</span> <span class="operator">=</span> <span class="number">0.5</span>;
                            <span class="name">jennifer</span>.<span class="name">opacity</span> <span class="operator">=</span> <span class="number">0.5</span>;
                            <span class="name">save</span>.<span class="name">opacity</span> <span class="operator">=</span> <span class="number">1.0</span>;
                            <span class="name">_app</span>.<span class="name">save</span> ();
                        }
                    }</pre>
<p>If the user clicks the 'Save' button, the <tt>save()</tt> method of the App object is invoked.</p>
<pre class="qml">                <span class="comment">// Container for displaying the loaded XBEL output</span>
                <span class="type">ScrollView</span> {
                    <span class="name">topMargin</span>: <span class="number">10</span>

                    <span class="type">scrollViewProperties</span> {
                        <span class="name">scrollMode</span>: <span class="name">ScrollMode</span>.<span class="name">Vertical</span>
                    }

                    <span class="name">layoutProperties</span>: <span class="name">StackLayoutProperties</span> {
                        <span class="name">spaceQuota</span>: <span class="number">1</span>
                    }

                    <span class="type">Container</span> {
                        <span class="name">objectName</span>: <span class="string">&quot;treeContainer&quot;</span>

                        <span class="name">leftPadding</span>: <span class="number">10</span>
                        <span class="name">rightPadding</span>: <span class="number">10</span>
                        <span class="name">bottomPadding</span>: <span class="number">10</span>
                    }
                }</pre>
<p>The container has the 'objectName' property set, so that it can be looked up from within C++.</p>
<a name="app"></a>
<h2>App</h2>
<p>Inside the constructor of <tt>App</tt> we load the main.qml file and retrieve the C++ object that represents the root node of the QML document. With the findChild() method we look up the <tt>Container</tt> object where we have assigned 'treeContainer' to the 'objectName' property.</p>
<pre class="cpp">    App<span class="operator">::</span>App()
    {
        <span class="comment">// Load the main QML file and make the App object available as context property</span>
        QmlDocument <span class="operator">*</span>qml <span class="operator">=</span> QmlDocument<span class="operator">::</span>create(<span class="string">&quot;asset:///main.qml&quot;</span>);
        <span class="keyword">if</span> (<span class="operator">!</span>qml<span class="operator">-</span><span class="operator">&gt;</span>hasErrors()) {
            qml<span class="operator">-</span><span class="operator">&gt;</span>setContextProperty(<span class="string">&quot;_app&quot;</span><span class="operator">,</span> <span class="keyword">this</span>);
            Page <span class="operator">*</span>appPage <span class="operator">=</span> qml<span class="operator">-</span><span class="operator">&gt;</span>createRootObject<span class="operator">&lt;</span>Page<span class="operator">&gt;</span>();
            <span class="keyword">if</span> (appPage) {
                Application<span class="operator">::</span>instance()<span class="operator">-</span><span class="operator">&gt;</span>setScene(appPage);

                <span class="comment">// Retrieve the tree container control from the QML file</span>
                m_treeContainer <span class="operator">=</span> appPage<span class="operator">-</span><span class="operator">&gt;</span>findChild<span class="operator">&lt;</span>Container<span class="operator">*</span><span class="operator">&gt;</span>(<span class="string">&quot;treeContainer&quot;</span>);
            }
        }
    }</pre>
<p>Whenever the user clicks one of the load buttons, the <tt>load()</tt> method of the App object is invoked with the file name passed as parameter.</p>
<pre class="cpp">    <span class="type">void</span> App<span class="operator">::</span>load(<span class="keyword">const</span> <span class="type">QString</span> <span class="operator">&amp;</span>fileName)
    {
        <span class="comment">// Do sanity check</span>
        <span class="keyword">if</span> (<span class="operator">!</span>m_treeContainer)
            <span class="keyword">return</span>;

        <span class="comment">// Update the status property</span>
        m_status <span class="operator">=</span> tr(<span class="string">&quot;Loading...&quot;</span>);
        <span class="keyword">emit</span> statusChanged();

        <span class="comment">// Clean all previous generated bookmark controls from the tree container</span>
        m_treeContainer<span class="operator">-</span><span class="operator">&gt;</span>removeAll();

        <span class="comment">// Create the XBEL reader and pass the tree container it will work on</span>
        XbelReader reader(m_treeContainer);

        <span class="comment">// Open the XBEL file which the user has selected</span>
        <span class="type">QFile</span> file(<span class="string">&quot;app/native/assets/&quot;</span> <span class="operator">+</span> fileName);
        <span class="keyword">if</span> (<span class="operator">!</span>file<span class="operator">.</span>open(<span class="type">QIODevice</span><span class="operator">::</span>ReadOnly))
            qWarning(<span class="string">&quot;unable to open file&quot;</span>);

        <span class="comment">// Parse XBEL file and generate the bookmark controls</span>
        <span class="keyword">const</span> <span class="type">bool</span> ok <span class="operator">=</span> reader<span class="operator">.</span>read(<span class="operator">&amp;</span>file);

        <span class="comment">// Update the status property again</span>
        <span class="keyword">if</span> (ok)
            m_status <span class="operator">=</span> tr(<span class="string">&quot;Loaded successfully&quot;</span>);
        <span class="keyword">else</span>
            m_status <span class="operator">=</span> reader<span class="operator">.</span>errorString();

        <span class="keyword">emit</span> statusChanged();
    }</pre>
<p>Inside <tt>load()</tt> we first remove all previously created controls from the <tt>treeContainer</tt> and then use the <tt>XbelReader</tt> class to parse the XML document and generate new controls inside the <tt>treeContainer</tt>.</p>
<p>If the user clicks the 'Save' button, the <tt>save()</tt> method of the App object is invoked.</p>
<pre class="cpp">    <span class="type">void</span> App<span class="operator">::</span>save()
    {
        <span class="comment">// Do sanity check</span>
        <span class="keyword">if</span> (<span class="operator">!</span>m_treeContainer)
            <span class="keyword">return</span>;

        <span class="comment">// Update the status property</span>
        m_status <span class="operator">=</span> tr(<span class="string">&quot;Saving...&quot;</span>);
        <span class="keyword">emit</span> statusChanged();

        <span class="keyword">const</span> <span class="type">QString</span> fileName(<span class="string">&quot;tmp/streambookmarks.xbel&quot;</span>);

        <span class="comment">// Open the target file where the modified XBEL document will be written to</span>
        <span class="type">QFile</span> file(fileName);
        file<span class="operator">.</span>open(<span class="type">QIODevice</span><span class="operator">::</span>WriteOnly);

        <span class="comment">// Create the XBEL writer on the tree container and let it generate the XBEL document from the bookmark controls</span>
        XbelWriter writer(m_treeContainer);
        <span class="keyword">const</span> <span class="type">bool</span> ok <span class="operator">=</span> writer<span class="operator">.</span>writeFile(<span class="operator">&amp;</span>file);

        <span class="comment">// Update the status property again</span>
        <span class="keyword">if</span> (ok)
            m_status <span class="operator">=</span> tr(<span class="string">&quot;Saved successfully&quot;</span>);
        <span class="keyword">else</span>
            m_status <span class="operator">=</span> tr(<span class="string">&quot;Error while saving&quot;</span>);

        <span class="keyword">emit</span> statusChanged();
    }</pre>
<p>Inside <tt>save()</tt> we try to open the file 'streambookmarks.xbel' inside the applications temp directory and then we use the <tt>XbelWriter</tt> class to iterate over the <tt>treeContainer</tt>, generate the XML document and store it to the file.</p>
<a name="xbelwriter-class-definition"></a>
<h2>XbelWriter Class Definition</h2>
<p>The <tt>XbelWriter</tt> class contains a private instance of QXmlStreamWriter, which provides an XML writer with a streaming API. <tt>XbelWriter</tt> also has a reference to the Container instance where the bookmark hierarchy is stored.</p>
<pre class="cpp">    <span class="comment">/**
     * The XbelWriter is responsible for generating a XBEL document from the
     * controls in the tree container.
     *
     * To generate the XBEL document the XbelWriter uses the QXmlStreamWriter class from Qt.
     */</span>
    <span class="keyword">class</span> XbelWriter
    {
    <span class="keyword">public</span>:
        XbelWriter(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>treeContainer);

        <span class="comment">// Starts the generation of the XBEL document</span>
        <span class="type">bool</span> writeFile(<span class="type">QIODevice</span> <span class="operator">*</span>device);

    <span class="keyword">private</span>:
        <span class="comment">// A helper method that generates an element in the XBEL document for the current control</span>
        <span class="type">void</span> writeItem(bb<span class="operator">::</span>cascades<span class="operator">::</span>Control <span class="operator">*</span>item);

        <span class="comment">// The XML stream writer that is used to generate the XBEL document</span>
        <span class="type">QXmlStreamWriter</span> m_xml;

        <span class="comment">// The container object the controls are located in</span>
        <span class="type">QPointer</span><span class="operator">&lt;</span>bb<span class="operator">::</span>cascades<span class="operator">::</span>Container<span class="operator">&gt;</span> m_treeContainer;
    };</pre>
<a name="xbelwriter-class-implementation"></a>
<h2>XbelWriter Class Implementation</h2>
<p>The <tt>XbelWriter</tt> constructor accepts a <i>treeContainer</i> to initialize within its definition. We enable QXmlStreamWriter's auto-formatting property to ensure line-breaks and indentations are added automatically to empty sections between elements, increasing readability as the data is split into several lines.</p>
<pre class="cpp">    XbelWriter<span class="operator">::</span>XbelWriter(Container <span class="operator">*</span>treeContainer)
        : m_treeContainer(treeContainer)
    {
        <span class="comment">// Make the output of the XML stream writer easier to read for humans</span>
        m_xml<span class="operator">.</span>setAutoFormatting(<span class="keyword">true</span>);
    }</pre>
<p>The <tt>writeFile()</tt> function accepts a QIODevice object and sets it using <tt>setDevice()</tt>. This function then writes the document type definition(DTD), the start element, the version, and <tt>treeContainer</tt>'s top-level items.</p>
<pre class="cpp">    <span class="type">bool</span> XbelWriter<span class="operator">::</span>writeFile(<span class="type">QIODevice</span> <span class="operator">*</span>device)
    {
        m_xml<span class="operator">.</span>setDevice(device);

        <span class="comment">// Start the creation of the document</span>
        m_xml<span class="operator">.</span>writeStartDocument();
        m_xml<span class="operator">.</span>writeDTD(<span class="string">&quot;&lt;!DOCTYPE xbel&gt;&quot;</span>);

        <span class="comment">// Add the root element with the necessary 'xbel' element and version attribute</span>
        m_xml<span class="operator">.</span>writeStartElement(<span class="string">&quot;xbel&quot;</span>);
        m_xml<span class="operator">.</span>writeAttribute(<span class="string">&quot;version&quot;</span><span class="operator">,</span> <span class="string">&quot;1.0&quot;</span>);

        <span class="comment">// Iterate over the controls of the tree container and generate an XBEL element for each of them</span>
        <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> m_treeContainer<span class="operator">-</span><span class="operator">&gt;</span>count(); <span class="operator">+</span><span class="operator">+</span>i)
            writeItem(m_treeContainer<span class="operator">-</span><span class="operator">&gt;</span>at(i));

        m_xml<span class="operator">.</span>writeEndDocument();

        <span class="keyword">return</span> <span class="keyword">true</span>;
    }</pre>
<p>The <tt>writeItem()</tt> function accepts a Control object and writes it to the stream, depending on its <tt>tagName</tt>, which can either be a &quot;folder&quot;, &quot;bookmark&quot;, or &quot;separator&quot;.</p>
<pre class="cpp">    <span class="type">void</span> XbelWriter<span class="operator">::</span>writeItem(Control <span class="operator">*</span>item)
    {
        <span class="keyword">const</span> Container <span class="operator">*</span>container <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>Container<span class="operator">*</span><span class="operator">&gt;</span>(item);

        <span class="comment">/**
         * Retrieve the tag name and title from the control.
         * These two properties have been set on the controls by the XbelReader.
         */</span>
        <span class="keyword">const</span> <span class="type">QString</span> tagName <span class="operator">=</span> container<span class="operator">-</span><span class="operator">&gt;</span>property(<span class="string">&quot;tagName&quot;</span>)<span class="operator">.</span>toString();
        <span class="keyword">const</span> <span class="type">QString</span> title <span class="operator">=</span> container<span class="operator">-</span><span class="operator">&gt;</span>property(<span class="string">&quot;title&quot;</span>)<span class="operator">.</span>toString();

        <span class="comment">// Depending on the tag name write a new element to the XBEL document</span>
        <span class="keyword">if</span> (tagName <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;folder&quot;</span>) {
            m_xml<span class="operator">.</span>writeStartElement(tagName);
            m_xml<span class="operator">.</span>writeAttribute(<span class="string">&quot;folded&quot;</span><span class="operator">,</span> <span class="string">&quot;no&quot;</span>);
            m_xml<span class="operator">.</span>writeTextElement(<span class="string">&quot;title&quot;</span><span class="operator">,</span> title);

            <span class="comment">// Iterate over the child controls of the container</span>
            <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> container<span class="operator">-</span><span class="operator">&gt;</span>count(); <span class="operator">+</span><span class="operator">+</span>i)
                writeItem(container<span class="operator">-</span><span class="operator">&gt;</span>at(i));

            m_xml<span class="operator">.</span>writeEndElement();
        } <span class="keyword">else</span> <span class="keyword">if</span> (tagName <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;bookmark&quot;</span>) {
            m_xml<span class="operator">.</span>writeStartElement(tagName);
            <span class="keyword">const</span> <span class="type">QString</span> url <span class="operator">=</span> container<span class="operator">-</span><span class="operator">&gt;</span>property(<span class="string">&quot;url&quot;</span>)<span class="operator">.</span>toString();
            <span class="keyword">if</span> (<span class="operator">!</span>url<span class="operator">.</span>isEmpty())
                m_xml<span class="operator">.</span>writeAttribute(<span class="string">&quot;href&quot;</span><span class="operator">,</span> url);
            m_xml<span class="operator">.</span>writeTextElement(<span class="string">&quot;title&quot;</span><span class="operator">,</span> title);
            m_xml<span class="operator">.</span>writeEndElement();
        } <span class="keyword">else</span> <span class="keyword">if</span> (tagName <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;separator&quot;</span>) {
            m_xml<span class="operator">.</span>writeEmptyElement(tagName);
        }
    }</pre>
<a name="xbelreader-class-definition"></a>
<h2>XbelReader Class Definition</h2>
<p>The <tt>XbelReader</tt> contains a private instance of QXmlStreamReader, the companion class to QXmlStreamWriter. <tt>XbelReader</tt> also contains a reference to the Container that is used to group the bookmarks according to their hierarchy.</p>
<pre class="cpp">    <span class="comment">/**
     * The XbelReader is responsible for parsing a XBEL file and generating
     * controls, that represent the bookmark entries, on the tree container.
     *
     * To parse the XBEL document the XbelReader uses the QXmlStreamReader class from Qt.
     */</span>
    <span class="keyword">class</span> XbelReader
    {
    <span class="keyword">public</span>:
        XbelReader(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>treeContainer);

        <span class="comment">// Starts the parsing of the XBEL document</span>
        <span class="type">bool</span> read(<span class="type">QIODevice</span> <span class="operator">*</span>device);

        <span class="comment">// Returns a textual representation of the error if one occurred</span>
        <span class="type">QString</span> errorString() <span class="keyword">const</span>;

    <span class="keyword">private</span>:
        <span class="comment">// A helper method that parses the root element of a XBEL document</span>
        <span class="type">void</span> readXBEL();

        <span class="comment">// A helper method that parses the title attribute of the current element</span>
        <span class="type">void</span> readTitle(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>item);

        <span class="comment">// A helper method that parses a separator element</span>
        <span class="type">void</span> readSeparator(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>item);

        <span class="comment">// A helper method that parses a folder element</span>
        <span class="type">void</span> readFolder(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>item);

        <span class="comment">// A helper method that parses a bookmark element</span>
        <span class="type">void</span> readBookmark(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>item);

        <span class="comment">// A helper method that generates a control for the current XBEL element</span>
        bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>createChildItem(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>parent);

        <span class="comment">// The XML stream reader that is used to parse the XBEL document</span>
        <span class="type">QXmlStreamReader</span> m_xml;

        <span class="comment">// The container object the controls are created in</span>
        <span class="type">QPointer</span><span class="operator">&lt;</span>bb<span class="operator">::</span>cascades<span class="operator">::</span>Container<span class="operator">&gt;</span> m_treeContainer;
    };</pre>
<a name="xbelreader-class-implementation"></a>
<h2>XbelReader Class Implementation</h2>
<p>The <tt>XbelReader</tt> constructor accepts a Container to initialize the <tt>treeContainer</tt> within its definition.</p>
<pre class="cpp">    XbelReader<span class="operator">::</span>XbelReader(Container <span class="operator">*</span>treeContainer)
        : m_treeContainer(treeContainer)
    {
    }</pre>
<p>The <tt>read()</tt> function accepts a QIODevice and sets it using setDevice(). The actual process of reading only takes place if the file is a valid XBEL 1.0 file. Note that the XML input needs to be well-formed to be accepted by QXmlStreamReader. Otherwise, the raiseError() function is used to display an error message. Since the XBEL reader is only concerned with reading XML elements, it makes extensive use of the readNextStartElement() convenience function.</p>
<pre class="cpp">    <span class="type">bool</span> XbelReader<span class="operator">::</span>read(<span class="type">QIODevice</span> <span class="operator">*</span>device)
    {
        <span class="comment">// Set the XBEL document as input data to the XML stream reader</span>
        m_xml<span class="operator">.</span>setDevice(device);

        <span class="comment">// Read the first element ...</span>
        <span class="keyword">if</span> (m_xml<span class="operator">.</span>readNextStartElement()) {
            <span class="comment">// ... and check whether this is a valid XBEL file in the correct version</span>
            <span class="keyword">if</span> (m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;xbel&quot;</span> <span class="operator">&amp;</span><span class="operator">&amp;</span> m_xml<span class="operator">.</span>attributes()<span class="operator">.</span>value(<span class="string">&quot;version&quot;</span>) <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;1.0&quot;</span>)
                readXBEL(); <span class="comment">// Start to parse the document</span>
            <span class="keyword">else</span>
                m_xml<span class="operator">.</span>raiseError(<span class="type">QObject</span><span class="operator">::</span>tr(<span class="string">&quot;The file is not an XBEL version 1.0 file.&quot;</span>));
        }

        <span class="keyword">return</span> <span class="operator">!</span>m_xml<span class="operator">.</span>error();
    }</pre>
<p>The <tt>errorString()</tt> function is used if an error occurred, in order to obtain a description of the error complete with line and column number information.</p>
<pre class="cpp">    <span class="type">QString</span> XbelReader<span class="operator">::</span>errorString() <span class="keyword">const</span>
    {
        <span class="keyword">return</span> <span class="type">QObject</span><span class="operator">::</span>tr(<span class="string">&quot;%1\nLine %2, column %3&quot;</span>)
                <span class="operator">.</span>arg(m_xml<span class="operator">.</span>errorString())
                <span class="operator">.</span>arg(m_xml<span class="operator">.</span>lineNumber())
                <span class="operator">.</span>arg(m_xml<span class="operator">.</span>columnNumber());
    }</pre>
<p>The <tt>readXBEL()</tt> function reads the name of a startElement and calls the appropriate function to read it, depending on whether if its a &quot;folder&quot;, &quot;bookmark&quot; or &quot;separator&quot;. Otherwise, it calls skipCurrentElement(). The Q_ASSERT() macro is used to provide a pre-condition for the function.</p>
<pre class="cpp">    <span class="type">void</span> XbelReader<span class="operator">::</span>readXBEL()
    {
        <span class="comment">// Do sanity check</span>
        Q_ASSERT(m_xml<span class="operator">.</span>isStartElement() <span class="operator">&amp;</span><span class="operator">&amp;</span> m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;xbel&quot;</span>);

        <span class="comment">// Iterate over the child elements</span>
        <span class="keyword">while</span> (m_xml<span class="operator">.</span>readNextStartElement()) {
            <span class="keyword">if</span> (m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;folder&quot;</span>)
                readFolder(m_treeContainer);
            <span class="keyword">else</span> <span class="keyword">if</span> (m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;bookmark&quot;</span>)
                readBookmark(m_treeContainer);
            <span class="keyword">else</span> <span class="keyword">if</span> (m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;separator&quot;</span>)
                readSeparator(m_treeContainer);
            <span class="keyword">else</span>
                m_xml<span class="operator">.</span>skipCurrentElement();
        }
    }</pre>
<p>The <tt>readTitle()</tt> function reads the bookmark's title.</p>
<pre class="cpp">    <span class="type">void</span> XbelReader<span class="operator">::</span>readTitle(Container <span class="operator">*</span>item)
    {
        <span class="comment">// Do sanity check</span>
        Q_ASSERT(m_xml<span class="operator">.</span>isStartElement() <span class="operator">&amp;</span><span class="operator">&amp;</span> m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;title&quot;</span>);

        <span class="comment">// Read the title property and set it on the control</span>
        <span class="keyword">const</span> <span class="type">QString</span> title <span class="operator">=</span> m_xml<span class="operator">.</span>readElementText();
        item<span class="operator">-</span><span class="operator">&gt;</span>setProperty(<span class="string">&quot;title&quot;</span><span class="operator">,</span> title);
    }</pre>
<p>The <tt>readSeparator()</tt> function creates a separator. The element is then skipped using skipCurrentElement().</p>
<pre class="cpp">    <span class="type">void</span> XbelReader<span class="operator">::</span>readSeparator(Container <span class="operator">*</span>item)
    {
        <span class="comment">// Do sanity check</span>
        Q_ASSERT(m_xml<span class="operator">.</span>isStartElement() <span class="operator">&amp;</span><span class="operator">&amp;</span> m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;separator&quot;</span>);

        <span class="comment">// Just create the control, no additional properties are set</span>
        createChildItem(item);
        m_xml<span class="operator">.</span>skipCurrentElement();
    }</pre>
<p>See the <a href="http://pyxml.sourceforge.net/topics/xbel/">XML Bookmark Exchange Language Resource Page</a> for more information about XBEL files.</p>
</div>
<!-- @@@xml/streambookmarks -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Portions Copyright 2012 Research In Motion Limited.
     <acronym title="Copyright">&copy;</acronym> 2008-2011 Nokia Corporation and/or its
     subsidiaries. Nokia, Qt and their respective logos are trademarks of Nokia Corporation 
     in Finland and/or other countries worldwide.</p>
  <p>
     All other trademarks are property of their respective owners. <a title="Privacy Policy"
     href="http://qt.nokia.com/about/privacy-policy">Privacy Policy</a></p>
  <br />
  <p>
    Licensees holding valid Qt Commercial licenses may use this document in accordance with the    Qt Commercial License Agreement provided with the Software or, alternatively, in accordance    with the terms contained in a written agreement between you and Nokia.</p>
  <p>
    Alternatively, this document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
