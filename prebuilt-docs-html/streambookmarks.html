<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- streambookmarks.qdoc -->
  <title>Cascades : QXmlStream Bookmarks Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt Cascades Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
<li>QXmlStream Bookmarks Example</li>
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#xbelwriter-class-definition">XbelWriter Class Definition</a></li>
<li class="level1"><a href="#xbelwriter-class-implementation">XbelWriter Class Implementation</a></li>
<li class="level1"><a href="#xbelreader-class-definition">XbelReader Class Definition</a></li>
<li class="level1"><a href="#xbelreader-class-implementation">XbelReader Class Implementation</a></li>
</ul>
</div>
<h1 class="title">QXmlStream Bookmarks Example</h1>
<span class="subtitle"></span>
<!-- $$$streambookmarks-description -->
<div class="descr"> <a name="details"></a>
<p>The QXmlStream Bookmarks example provides a reader for XML Bookmark Exchange Language (XBEL) files using Qt's <a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html">QXmlStreamReader</a> class for reading, and <a href="http://qt.nokia.com/doc/4.7/qxmlstreamwriter.html">QXmlStreamWriter</a> class for writing the files.</p>
<p class="centerAlign"><img src="images/streambookmarks-example-rim.png" /></p><a name="xbelwriter-class-definition"></a>
<h2>XbelWriter Class Definition</h2>
<p>The <tt>XbelWriter</tt> class contains a private instance of <a href="http://qt.nokia.com/doc/4.7/qxmlstreamwriter.html">QXmlStreamWriter</a>, which provides an XML writer with a streaming API. <tt>XbelWriter</tt> also has a reference to the Container instance where the bookmark hierarchy is stored.</p>
<pre class="cpp">    <span class="comment">/**
     * The XbelWriter is responsible for generating a XBEL document from the
     * controls in the tree container.
     *
     * To generate the XBEL document the XbelWriter uses the QXmlStreamWriter class from Qt.
     */</span>
    <span class="keyword">class</span> XbelWriter
    {
    <span class="keyword">public</span>:
        XbelWriter(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>treeContainer);

        <span class="comment">// Starts the generation of the XBEL document</span>
        <span class="type">bool</span> writeFile(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span> <span class="operator">*</span>device);

    <span class="keyword">private</span>:
        <span class="comment">// A helper method that generates an element in the XBEL document for the current control</span>
        <span class="type">void</span> writeItem(bb<span class="operator">::</span>cascades<span class="operator">::</span>Control <span class="operator">*</span>item);

        <span class="comment">// The XML stream writer that is used to generate the XBEL document</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qxmlstreamwriter.html">QXmlStreamWriter</a></span> m_xml;

        <span class="comment">// The container object the controls are located in</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpointer.html">QPointer</a></span><span class="operator">&lt;</span>bb<span class="operator">::</span>cascades<span class="operator">::</span>Container<span class="operator">&gt;</span> m_treeContainer;
    };</pre>
<a name="xbelwriter-class-implementation"></a>
<h2>XbelWriter Class Implementation</h2>
<p>The <tt>XbelWriter</tt> constructor accepts a <i>treeContainer</i> to initialize within its definition. We enable <a href="http://qt.nokia.com/doc/4.7/qxmlstreamwriter.html">QXmlStreamWriter</a>'s auto-formatting property to ensure line-breaks and indentations are added automatically to empty sections between elements, increasing readability as the data is split into several lines.</p>
<pre class="cpp">    XbelWriter<span class="operator">::</span>XbelWriter(Container <span class="operator">*</span>treeContainer)
        : m_treeContainer(treeContainer)
    {
        <span class="comment">// Make the output of the XML stream writer easier to read for humans</span>
        m_xml<span class="operator">.</span>setAutoFormatting(<span class="keyword">true</span>);
    }</pre>
<p>The <tt>writeFile()</tt> function accepts a <a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a> object and sets it using <tt>setDevice()</tt>. This function then writes the document type definition(DTD), the start element, the version, and <tt>treeContainer</tt>'s top-level items.</p>
<pre class="cpp">    <span class="type">bool</span> XbelWriter<span class="operator">::</span>writeFile(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span> <span class="operator">*</span>device)
    {
        m_xml<span class="operator">.</span>setDevice(device);

        <span class="comment">// Start the creation of the document</span>
        m_xml<span class="operator">.</span>writeStartDocument();
        m_xml<span class="operator">.</span>writeDTD(<span class="string">&quot;&lt;!DOCTYPE xbel&gt;&quot;</span>);

        <span class="comment">// Add the root element with the necessary 'xbel' element and version attribute</span>
        m_xml<span class="operator">.</span>writeStartElement(<span class="string">&quot;xbel&quot;</span>);
        m_xml<span class="operator">.</span>writeAttribute(<span class="string">&quot;version&quot;</span><span class="operator">,</span> <span class="string">&quot;1.0&quot;</span>);

        <span class="comment">// Iterate over the controls of the tree container and generate an XBEL element for each of them</span>
        <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> m_treeContainer<span class="operator">-</span><span class="operator">&gt;</span>count(); <span class="operator">+</span><span class="operator">+</span>i)
            writeItem(m_treeContainer<span class="operator">-</span><span class="operator">&gt;</span>at(i));

        m_xml<span class="operator">.</span>writeEndDocument();

        <span class="keyword">return</span> <span class="keyword">true</span>;
    }</pre>
<p>The <tt>writeItem()</tt> function accepts a Control object and writes it to the stream, depending on its <tt>tagName</tt>, which can either be a &quot;folder&quot;, &quot;bookmark&quot;, or &quot;separator&quot;.</p>
<pre class="cpp">    <span class="type">void</span> XbelWriter<span class="operator">::</span>writeItem(Control <span class="operator">*</span>item)
    {
        <span class="keyword">const</span> Container <span class="operator">*</span>container <span class="operator">=</span> qobject_cast<span class="operator">&lt;</span>Container<span class="operator">*</span><span class="operator">&gt;</span>(item);

        <span class="comment">/**
         * Retrieve the tag name and title from the control.
         * These two properties have been set on the controls by the XbelReader.
         */</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> tagName <span class="operator">=</span> container<span class="operator">-</span><span class="operator">&gt;</span>property(<span class="string">&quot;tagName&quot;</span>)<span class="operator">.</span>toString();
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> title <span class="operator">=</span> container<span class="operator">-</span><span class="operator">&gt;</span>property(<span class="string">&quot;title&quot;</span>)<span class="operator">.</span>toString();

        <span class="comment">// Depending on the tag name write a new element to the XBEL document</span>
        <span class="keyword">if</span> (tagName <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;folder&quot;</span>) {
            m_xml<span class="operator">.</span>writeStartElement(tagName);
            m_xml<span class="operator">.</span>writeAttribute(<span class="string">&quot;folded&quot;</span><span class="operator">,</span> <span class="string">&quot;no&quot;</span>);
            m_xml<span class="operator">.</span>writeTextElement(<span class="string">&quot;title&quot;</span><span class="operator">,</span> title);

            <span class="comment">// Iterate over the child controls of the container</span>
            <span class="keyword">for</span> (<span class="type">int</span> i <span class="operator">=</span> <span class="number">0</span>; i <span class="operator">&lt;</span> container<span class="operator">-</span><span class="operator">&gt;</span>count(); <span class="operator">+</span><span class="operator">+</span>i)
                writeItem(container<span class="operator">-</span><span class="operator">&gt;</span>at(i));

            m_xml<span class="operator">.</span>writeEndElement();
        } <span class="keyword">else</span> <span class="keyword">if</span> (tagName <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;bookmark&quot;</span>) {
            m_xml<span class="operator">.</span>writeStartElement(tagName);
            <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> url <span class="operator">=</span> container<span class="operator">-</span><span class="operator">&gt;</span>property(<span class="string">&quot;url&quot;</span>)<span class="operator">.</span>toString();
            <span class="keyword">if</span> (<span class="operator">!</span>url<span class="operator">.</span>isEmpty())
                m_xml<span class="operator">.</span>writeAttribute(<span class="string">&quot;href&quot;</span><span class="operator">,</span> url);
            m_xml<span class="operator">.</span>writeTextElement(<span class="string">&quot;title&quot;</span><span class="operator">,</span> title);
            m_xml<span class="operator">.</span>writeEndElement();
        } <span class="keyword">else</span> <span class="keyword">if</span> (tagName <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;separator&quot;</span>) {
            m_xml<span class="operator">.</span>writeEmptyElement(tagName);
        }
    }</pre>
<a name="xbelreader-class-definition"></a>
<h2>XbelReader Class Definition</h2>
<p>The <tt>XbelReader</tt> contains a private instance of <a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html">QXmlStreamReader</a>, the companion class to <a href="http://qt.nokia.com/doc/4.7/qxmlstreamwriter.html">QXmlStreamWriter</a>. <tt>XbelReader</tt> also contains a reference to the Container that is used to group the bookmarks according to their hierarchy.</p>
<pre class="cpp">    <span class="comment">/**
     * The XbelReader is responsible for parsing a XBEL file and generating
     * controls, that represent the bookmark entries, on the tree container.
     *
     * To parse the XBEL document the XbelReader uses the QXmlStreamReader class from Qt.
     */</span>
    <span class="keyword">class</span> XbelReader
    {
    <span class="keyword">public</span>:
        XbelReader(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>treeContainer);

        <span class="comment">// Starts the parsing of the XBEL document</span>
        <span class="type">bool</span> read(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span> <span class="operator">*</span>device);

        <span class="comment">// Returns a textual representation of the error if one occurred</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> errorString() <span class="keyword">const</span>;

    <span class="keyword">private</span>:
        <span class="comment">// A helper method that parses the root element of a XBEL document</span>
        <span class="type">void</span> readXBEL();

        <span class="comment">// A helper method that parses the title attribute of the current element</span>
        <span class="type">void</span> readTitle(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>item);

        <span class="comment">// A helper method that parses a separator element</span>
        <span class="type">void</span> readSeparator(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>item);

        <span class="comment">// A helper method that parses a folder element</span>
        <span class="type">void</span> readFolder(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>item);

        <span class="comment">// A helper method that parses a bookmark element</span>
        <span class="type">void</span> readBookmark(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>item);

        <span class="comment">// A helper method that generates a control for the current XBEL element</span>
        bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>createChildItem(bb<span class="operator">::</span>cascades<span class="operator">::</span>Container <span class="operator">*</span>parent);

        <span class="comment">// The XML stream reader that is used to parse the XBEL document</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html">QXmlStreamReader</a></span> m_xml;

        <span class="comment">// The container object the controls are created in</span>
        <span class="type"><a href="http://qt.nokia.com/doc/4.7/qpointer.html">QPointer</a></span><span class="operator">&lt;</span>bb<span class="operator">::</span>cascades<span class="operator">::</span>Container<span class="operator">&gt;</span> m_treeContainer;
    };</pre>
<a name="xbelreader-class-implementation"></a>
<h2>XbelReader Class Implementation</h2>
<p>The <tt>XbelReader</tt> constructor accepts a Container to initialize the <tt>treeWidget</tt> within its definition.</p>
<pre class="cpp">    XbelReader<span class="operator">::</span>XbelReader(Container <span class="operator">*</span>treeContainer)
        : m_treeContainer(treeContainer)
    {
    }</pre>
<p>The <tt>read()</tt> function accepts a <a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a> and sets it using <a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html#setDevice">setDevice()</a>. The actual process of reading only takes place if the file is a valid XBEL 1.0 file. Note that the XML input needs to be well-formed to be accepted by <a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html">QXmlStreamReader</a>. Otherwise, the <a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html#raiseError">raiseError()</a> function is used to display an error message. Since the XBEL reader is only concerned with reading XML elements, it makes extensive use of the <a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html#readNextStartElement">readNextStartElement()</a> convenience function.</p>
<pre class="cpp">    <span class="type">bool</span> XbelReader<span class="operator">::</span>read(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qiodevice.html">QIODevice</a></span> <span class="operator">*</span>device)
    {
        <span class="comment">// Set the XBEL document as input data to the XML stream reader</span>
        m_xml<span class="operator">.</span>setDevice(device);

        <span class="comment">// Read the first element ...</span>
        <span class="keyword">if</span> (m_xml<span class="operator">.</span>readNextStartElement()) {
            <span class="comment">// ... and check whether this is a valid XBEL file in the correct version</span>
            <span class="keyword">if</span> (m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;xbel&quot;</span> <span class="operator">&amp;</span><span class="operator">&amp;</span> m_xml<span class="operator">.</span>attributes()<span class="operator">.</span>value(<span class="string">&quot;version&quot;</span>) <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;1.0&quot;</span>)
                readXBEL(); <span class="comment">// Start to parse the document</span>
            <span class="keyword">else</span>
                m_xml<span class="operator">.</span>raiseError(<span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">::</span>tr(<span class="string">&quot;The file is not an XBEL version 1.0 file.&quot;</span>));
        }

        <span class="keyword">return</span> <span class="operator">!</span>m_xml<span class="operator">.</span>error();
    }</pre>
<p>The <tt>errorString()</tt> function is used if an error occurred, in order to obtain a description of the error complete with line and column number information.</p>
<pre class="cpp">    <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> XbelReader<span class="operator">::</span>errorString() <span class="keyword">const</span>
    {
        <span class="keyword">return</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qobject.html">QObject</a></span><span class="operator">::</span>tr(<span class="string">&quot;%1\nLine %2, column %3&quot;</span>)
                <span class="operator">.</span>arg(m_xml<span class="operator">.</span>errorString())
                <span class="operator">.</span>arg(m_xml<span class="operator">.</span>lineNumber())
                <span class="operator">.</span>arg(m_xml<span class="operator">.</span>columnNumber());
    }</pre>
<p>The <tt>readXBEL()</tt> function reads the name of a startElement and calls the appropriate function to read it, depending on whether if its a &quot;folder&quot;, &quot;bookmark&quot; or &quot;separator&quot;. Otherwise, it calls <a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html#skipCurrentElement">skipCurrentElement()</a>. The <a href="http://qt.nokia.com/doc/4.7/qtglobal.html#Q_ASSERT">Q_ASSERT</a>() macro is used to provide a pre-condition for the function.</p>
<pre class="cpp">    <span class="type">void</span> XbelReader<span class="operator">::</span>readXBEL()
    {
        <span class="comment">// Do sanity check</span>
        Q_ASSERT(m_xml<span class="operator">.</span>isStartElement() <span class="operator">&amp;</span><span class="operator">&amp;</span> m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;xbel&quot;</span>);

        <span class="comment">// Iterate over the child elements</span>
        <span class="keyword">while</span> (m_xml<span class="operator">.</span>readNextStartElement()) {
            <span class="keyword">if</span> (m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;folder&quot;</span>)
                readFolder(m_treeContainer);
            <span class="keyword">else</span> <span class="keyword">if</span> (m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;bookmark&quot;</span>)
                readBookmark(m_treeContainer);
            <span class="keyword">else</span> <span class="keyword">if</span> (m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;separator&quot;</span>)
                readSeparator(m_treeContainer);
            <span class="keyword">else</span>
                m_xml<span class="operator">.</span>skipCurrentElement();
        }
    }</pre>
<p>The <tt>readTitle()</tt> function reads the bookmark's title.</p>
<pre class="cpp">    <span class="type">void</span> XbelReader<span class="operator">::</span>readTitle(Container <span class="operator">*</span>item)
    {
        <span class="comment">// Do sanity check</span>
        Q_ASSERT(m_xml<span class="operator">.</span>isStartElement() <span class="operator">&amp;</span><span class="operator">&amp;</span> m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;title&quot;</span>);

        <span class="comment">// Read the title property and set it on the control</span>
        <span class="keyword">const</span> <span class="type"><a href="http://qt.nokia.com/doc/4.7/qstring.html">QString</a></span> title <span class="operator">=</span> m_xml<span class="operator">.</span>readElementText();
        item<span class="operator">-</span><span class="operator">&gt;</span>setProperty(<span class="string">&quot;title&quot;</span><span class="operator">,</span> title);
    }</pre>
<p>The <tt>readSeparator()</tt> function creates a separator. The element is then skipped using <a href="http://qt.nokia.com/doc/4.7/qxmlstreamreader.html#skipCurrentElement">skipCurrentElement()</a>.</p>
<pre class="cpp">    <span class="type">void</span> XbelReader<span class="operator">::</span>readSeparator(Container <span class="operator">*</span>item)
    {
        <span class="comment">// Do sanity check</span>
        Q_ASSERT(m_xml<span class="operator">.</span>isStartElement() <span class="operator">&amp;</span><span class="operator">&amp;</span> m_xml<span class="operator">.</span>name() <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;separator&quot;</span>);

        <span class="comment">// Just create the control, no additional properties are set</span>
        createChildItem(item);
        m_xml<span class="operator">.</span>skipCurrentElement();
    }</pre>
<p>See the <a href="http://pyxml.sourceforge.net/topics/xbel/">XML Bookmark Exchange Language Resource Page</a> for more information about XBEL files.</p>
</div>
<!-- @@@streambookmarks -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Portions Copyright 2012 Research In Motion Limited.
     <acronym title="Copyright">&copy;</acronym> 2008-2011 Nokia Corporation and/or its
     subsidiaries. Nokia, Qt and their respective logos are trademarks of Nokia Corporation 
     in Finland and/or other countries worldwide.</p>
  <p>
     All other trademarks are property of their respective owners. <a title="Privacy Policy"
     href="http://qt.nokia.com/about/privacy-policy">Privacy Policy</a></p>
  <br />
  <p>
    Licensees holding valid Qt Commercial licenses may use this document in accordance with the    Qt Commercial License Agreement provided with the Software or, alternatively, in accordance    with the terms contained in a written agreement between you and Nokia.</p>
  <p>
    Alternatively, this document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
